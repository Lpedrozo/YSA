@model List<YSA.Web.Models.ViewModels.AnuncioViewModel>
@{
    ViewData["Title"] = "Gestión de anuncios";
}

<style>
    /* ------------------------------------- */
    /* 1. Variables B&W y Estilos Generales  */
    /* ------------------------------------- */
    :root {
        --color-secondary: #000000; /* Negro Puro (Título) */
        --color-primary: #333333; /* Gris Oscuro (Botones, Acentos) */
        --color-text-muted: #6a6a6a; /* Gris medio (Descripción) */
        --color-background-light: #f7f7f7; /* Fondo general de la página */
        --color-background-white: #ffffff; /* Fondo para las tarjetas */
        --color-border-light: #eeeeee; /* Borde sutil */
    }

    body {
        background-color: var(--color-background-light);
        color: var(--color-primary);
    }

    h1 {
        color: var(--color-secondary);
        font-weight: 700;
    }

    hr {
        border-top: 2px solid var(--color-border-light);
        opacity: 1;
    }

    /* Estilos del botón de "Nuevo Anuncio" (Green -> B&W) */
    .btn-success {
        background-color: var(--color-primary) !important;
        border-color: var(--color-primary) !important;
        color: white !important;
        font-weight: 600;
        transition: background-color 0.2s;
        border-radius: 8px;
    }

        .btn-success:hover {
            background-color: var(--color-secondary) !important;
            border-color: var(--color-secondary) !important;
        }

    /* ------------------------------------- */
    /* 2. Estilos de las Cards de Anuncio    */
    /* ------------------------------------- */
    .anuncio-card {
        border: 1px solid var(--color-border-light);
        border-radius: 12px;
        background-color: var(--color-background-white);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: box-shadow 0.3s;
    }

        .anuncio-card:hover {
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        }

    .card-title {
        font-weight: 700;
        color: var(--color-secondary);
        font-size: 1.25rem;
    }

    .card-subtitle {
        color: var(--color-text-muted);
        font-size: 0.85rem;
    }

    .card-text-content {
        color: var(--color-primary);
        font-size: 0.9rem;
        /* Limitar el contenido para que no sea muy largo */
        display: -webkit-box;
        -webkit-line-clamp: 3; /* Mostrar máximo 3 líneas */
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-top: 10px;
    }

    /* Estilos de Botones de Acción dentro de la card (B&W) */
    .btn-primary {
        background-color: var(--color-primary) !important;
        border-color: var(--color-primary) !important;
        color: white !important;
        transition: background-color 0.2s;
    }

        .btn-primary:hover {
            background-color: var(--color-secondary) !important;
            border-color: var(--color-secondary) !important;
        }

    .btn-danger {
        /* Mantenemos el rojo para eliminar por seguridad, pero con estilo limpio */
        border-radius: 6px;
    }

    /* ------------------------------------- */
    /* 3. MEDIA QUERY RESPONSIVE (MÓVIL)     */
    /* ------------------------------------- */
    @@media (max-width: 575.98px) { /* Pantallas extra pequeñas (móvil) */
        .container.mt-5 {
            /* Reduce el margen superior y lateral en móvil */
            margin-top: 1.5rem !important;
            padding: 0 1rem;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1.5rem !important;
        }

        .d-flex.justify-content-end.mb-4 {
            /* Centra el botón y le da ancho completo en móvil */
            justify-content: center !important;
        }

        .btn-success {
            /* Botón de 'Nuevo Anuncio' de ancho completo para fácil pulsación */
            width: 100%;
            max-width: 300px; /* Limita el ancho máximo para que no se vea ridículo en pantallas muy anchas, aunque estemos en el media query de móvil */
        }

        .row-cols-1 .col {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
    }
</style>

<div class="container mt-5 mb-5 pb-5">
    <h1 class="text-center mb-5">Gestión de anuncios</h1>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <a asp-action="Panel" asp-controller="Admin" class="btn btn-primary">
            <i class="fas fa-arrow-left me-2"></i> Regresar al panel
        </a>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#crearAnuncioModal">
            <i class="fas fa-plus-circle me-2"></i> Nuevo anuncio
        </button>
    </div>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info text-center" role="alert" style="border-radius: 8px;">
            No hay anuncios creados aún. Haz clic en **Nuevo Anuncio** para empezar.
        </div>
    }
    else
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4 mb-5 pb-5">
            @foreach (var anuncio in Model)
            {
                <div class="col">
                    <div class="card anuncio-card h-100 p-3">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@anuncio.Titulo</h5>
                            <h6 class="card-subtitle mb-2">Publicado: @anuncio.FechaPublicacion.ToShortDateString()</h6>

                            <p class="card-text card-text-content flex-grow-1">
                                @Html.Raw(anuncio.Contenido)
                            </p>

                            <div class="mt-3 pt-2 border-top d-flex justify-content-end">

                                <button type="button" class="btn btn-sm btn-primary editar-anuncio-btn me-2"
                                        data-id="@anuncio.Id"
                                        data-titulo="@anuncio.Titulo"
                                        data-contenido="@anuncio.Contenido"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editarAnuncioModal">
                                    <i class="fas fa-edit"></i> Editar
                                </button>

                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<div class="modal fade" id="crearAnuncioModal" tabindex="-1" aria-labelledby="crearAnuncioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crearAnuncioModalLabel" style="color:var(--color-secondary);">Crear anuncio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="CrearAnuncio" method="post" novalidate>
                <div class="modal-body">
                    <input type="hidden" name="CursoId" value="@ViewBag.CursoId" />
                    <div class="form-group mb-3">
                        <label for="Titulo" style="color:var(--color-primary);">Título</label>
                        <input type="text" name="Titulo" class="form-control" required />
                    </div>
                    <div class="form-group mb-3">
                        <label for="Contenido" style="color:var(--color-primary);">Contenido</label>
                        <textarea name="Contenido" class="tinymce-full-editor" rows="8"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editarAnuncioModal" tabindex="-1" aria-labelledby="editarAnuncioModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarAnuncioModalLabel" style="color:var(--color-secondary);">Editar anuncio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="EditarAnuncio" method="post" novalidate>
                <div class="modal-body">
                    <input type="hidden" name="Id" id="editar-anuncio-id" />
                    <input type="hidden" name="CursoId" value="@ViewBag.CursoId" />
                    <div class="form-group mb-3">
                        <label for="Titulo" style="color:var(--color-primary);">Título</label>
                        <input type="text" name="Titulo" id="editar-anuncio-titulo" class="form-control" required />
                    </div>
                    <div class="form-group mb-3">
                        <label for="Contenido" style="color:var(--color-primary);">Contenido</label>
                        <textarea name="Contenido" id="editar-anuncio-contenido" class="tinymce-full-editor" rows="8"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Actualizar</button>
                </div>
            </form>
        </div>
    </div>
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.tiny.cloud/1/72k2eqfy02quriyevi4t2ctxtg50ucyx8gngemudhw0tyn9w/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        // Función clave para permitir que TinyMCE funcione dentro de un modal de Bootstrap
        function tinymceModalSetup(editor) {
            editor.on('init', function() {
                // Cuando el modal de Bootstrap se muestra:
                $(editor.getContainer()).parents('.modal').on('shown.bs.modal', function () {
                    editor.focus();
                });
            });
        }

        // Inicialización para el campo de Contenido
        tinymce.init({
            selector: 'textarea.tinymce-full-editor',
            plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
            toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
            height: 300,
            setup: tinymceModalSetup // Aplicar la corrección de foco del modal
        });

        // Esperar a que el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', function () {

            // Lógica para llenar el modal de edición
            document.querySelectorAll('.editar-anuncio-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const titulo = this.getAttribute('data-titulo');
                    const contenido = this.getAttribute('data-contenido');

                    document.getElementById('editar-anuncio-id').value = id;
                    document.getElementById('editar-anuncio-titulo').value = titulo;

                    // PASO 4: ACTUALIZAR EL CONTENIDO EN TINYMCE
                    // En lugar de actualizar el textarea directamente, usamos el API de TinyMCE

                    // 1. Destruir la instancia existente (para evitar conflictos al abrir múltiples veces)
                    var editorId = 'editar-anuncio-contenido';
                    if (tinymce.get(editorId)) {
                        tinymce.get(editorId).remove();
                    }

                    // 2. Inicializar de nuevo y establecer el contenido
                    tinymce.init({
                        selector: '#' + editorId,
                        plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
                        toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                        height: 300,
                        setup: function (editor) {
                            tinymceModalSetup(editor); // Aplicar la corrección de foco
                            editor.on('init', function (e) {
                                // Establecer el contenido SÓLO después de que el editor se haya inicializado
                                editor.setContent(contenido);
                            });
                        }
                    });
                });
            });

            // ... (Lógica para SweetAlert2 se mantiene igual) ...
            document.querySelectorAll('.eliminar-anuncio-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const form = this.closest('form');

                    Swal.fire({
                        title: '¿Estás seguro?',
                        text: "¡No podrás revertir esto!",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#dc3545',
                        cancelButtonColor: '#6a6a6a',
                        confirmButtonText: 'Sí, ¡bórralo!',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            form.submit();
                        }
                    });
                });
            });

            // Importante: Re-inicializar el editor de CREAR cada vez que se abre el modal,
            // si el modal de EDITAR lo está destruyendo.
            // Una solución más simple es NO DESTRUIR el editor de Crear, solo el de Editar.
            // Si el editor de Crear (el que usa la clase) no se inicializó, lo hacemos aquí:
            if (!tinymce.get(document.querySelector('textarea.tinymce-full-editor[name="Contenido"]'))) {
                tinymce.init({
                    selector: 'textarea.tinymce-full-editor[name="Contenido"]', // Solo el de Crear
                    plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
                    toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                    height: 300,
                    setup: tinymceModalSetup
                });
            }

        });
    </script>
}