@model List<YSA.Web.Models.ViewModels.RecursoActividadViewModel>
@{
    // Valores pasados desde el controlador
    string tipoEntidad = ViewBag.TipoEntidad;
    int entidadId = ViewBag.EntidadId;
    string entidadNombre = ViewBag.EntidadNombre;
    int cursoId = ViewBag.CursoId;
    var tiposRecurso = ViewBag.TiposRecurso as SelectList;

    ViewData["Title"] = $"Gestión de Recursos/Actividades para {tipoEntidad} - {entidadNombre}";
}

<style>
    /* IMPORTACIÓN DE TIPOGRAFÍAS Y VARIABLES COHERENTES CON EL DISEÑO EDITORIAL */
    :root {
        --color-primary-action: #ef8830;
        --color-secondary: #212529;
        --color-accent: #6c757d;
        --color-background: #ffffff;
        --color-card-bg: #ffffff;
        --color-text-dark: #212529;
        --color-text-light: #ffffff;
        --color-border: #E8E8E8;
        --color-alert: #e5361a;
        --color-shadow-light: rgba(0, 0, 0, 0.1);
        --color-section-bg: #f8f9fa;
        --color-brand-primary: #ef8830;
        --color-brand-secondary: #e5361a;
        --color-brand-accent: #f2e514;
        --color-brand-success: #6db53e;
        --color-brand-dark: #08080a;
        --font-heading: 'Georgia', 'Times New Roman', serif;
        --font-body: 'Arial', 'Helvetica', sans-serif;
        --font-accent: 'Poppins', sans-serif;
        --line-height-tight: 1.1;
        --line-height-normal: 1.4;
        --line-height-loose: 1.6;
        --border-radius-sm: 8px;
        --border-radius-md: 12px;
        --border-radius-lg: 16px;
        --border-radius-xl: 20px;
    }

    body {
        font-family: var(--font-body);
        background-color: var(--color-background);
        color: var(--color-text-dark);
        line-height: var(--line-height-loose);
    }

    /* PORTADA DE REVISTA PARA GESTIÓN */
    .management-cover {
        width: 100%;
        height: 35vh;
        background-color: #f4f4f4;
        position: relative;
        overflow: hidden;
        margin-bottom: 3rem;
    }

    .cover-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
    }

    .cover-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 0%, rgba(0, 0, 0, 0) 60%);
        z-index: 2;
        display: flex;
        align-items: flex-end;
        padding: 3rem;
    }

    .cover-title-block {
        color: var(--color-text-light);
        max-width: 700px;
        z-index: 3;
    }

    .cover-title {
        font-family: var(--font-heading);
        font-size: 2.5rem;
        font-weight: 900;
        line-height: var(--line-height-tight);
        margin-bottom: 0.5rem;
    }

    .cover-subtitle {
        font-family: var(--font-body);
        font-size: 1.3rem;
        font-weight: 300;
        color: rgba(255, 255, 255, 0.8);
        line-height: var(--line-height-normal);
    }

    /* SECCIONES CON FONDO Y BORDES REDONDEADOS */
    .section-container {
        background: var(--color-section-bg);
        border-radius: var(--border-radius-lg);
        padding: 3rem 2rem;
        margin: 2rem 0;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    /* TÍTULOS DE SECCIÓN ESTILO REVISTA */
    .section-title {
        font-family: var(--font-heading);
        font-size: 2.2rem;
        font-weight: 800;
        color: var(--color-secondary);
        padding-bottom: 0.5rem;
        margin-bottom: 2rem;
        display: inline-block;
        border-bottom: 4px solid var(--color-brand-primary);
        letter-spacing: 1px;
        text-transform: uppercase;
        line-height: var(--line-height-tight);
    }

    .latest-grid-header {
        font-family: var(--font-heading);
        font-size: 1.8rem;
        font-weight: 800;
        color: var(--color-secondary);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 2rem;
        border-bottom: 2px solid var(--color-brand-primary);
        padding-bottom: 0.5rem;
        display: block;
        line-height: var(--line-height-tight);
    }

    /* BOTONES CON ESTILO EDITORIAL */
    .btn-primary {
        background-color: var(--color-brand-primary);
        border-color: var(--color-brand-primary);
        color: var(--color-text-light);
        font-family: var(--font-accent);
        font-weight: 600;
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

        .btn-primary:hover {
            background-color: #e57a20;
            border-color: #e57a20;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 136, 48, 0.3);
        }

    .btn-success {
        background-color: var(--color-brand-success);
        border-color: var(--color-brand-success);
        color: var(--color-text-light);
        font-family: var(--font-accent);
        font-weight: 600;
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

        .btn-success:hover {
            background-color: #5da336;
            border-color: #5da336;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(109, 181, 62, 0.3);
        }

    .btn-secondary {
        background-color: var(--color-accent);
        border-color: var(--color-accent);
        color: var(--color-text-light);
        font-family: var(--font-accent);
        font-weight: 600;
        border-radius: var(--border-radius-sm);
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
    }

        .btn-secondary:hover {
            background-color: #5a6268;
            border-color: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

    .btn-info {
        background-color: var(--color-brand-primary);
        border-color: var(--color-brand-primary);
        color: var(--color-text-light);
        font-family: var(--font-accent);
        font-weight: 600;
        border-radius: var(--border-radius-sm);
        padding: 0.5rem 1rem;
        transition: all 0.3s ease;
    }

        .btn-info:hover {
            background-color: #e57a20;
            border-color: #e57a20;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 136, 48, 0.3);
        }

    /* TARJETAS DE RECURSOS ESTILO EDITORIAL */
    .resource-card {
        background-color: var(--color-card-bg);
        border-radius: var(--border-radius-md);
        border: 1px solid var(--color-border);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
        overflow: hidden;
    }

        .resource-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            border-color: var(--color-brand-primary);
        }

    .resource-header {
        background-color: var(--color-section-bg);
        padding: 1.5rem;
        border-bottom: 1px solid var(--color-border);
    }

    .resource-body {
        padding: 1.5rem;
    }

    .resource-title {
        font-family: var(--font-heading);
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--color-secondary);
        margin-bottom: 0.5rem;
        line-height: var(--line-height-normal);
    }

    .resource-meta {
        font-family: var(--font-accent);
        font-size: 0.9rem;
        color: var(--color-accent);
        margin-bottom: 0.5rem;
    }

    .resource-url {
        font-family: var(--font-body);
        font-size: 0.9rem;
        color: var(--color-brand-primary);
        word-break: break-all;
    }

    /* BADGES ESTILO EDITORIAL */
    .badge.bg-warning {
        background-color: var(--color-brand-accent) !important;
        color: var(--color-brand-dark) !important;
        font-family: var(--font-accent);
        font-weight: 600;
        border-radius: var(--border-radius-sm);
        padding: 0.4rem 0.8rem;
        font-size: 0.8rem;
    }

    .badge.bg-light {
        background-color: var(--color-brand-accent) !important;
        color: var(--color-brand-dark) !important;
        font-family: var(--font-accent);
        font-weight: 600;
        border-radius: var(--border-radius-sm);
        padding: 0.5rem 1rem;
    }

    /* ALERTAS ESTILO EDITORIAL */
    .alert {
        border-radius: var(--border-radius-md);
        border: none;
        padding: 1.5rem 2rem;
        font-family: var(--font-body);
        margin-bottom: 2rem;
    }

    .alert-success {
        background-color: rgba(109, 181, 62, 0.1);
        color: var(--color-brand-success);
        border-left: 4px solid var(--color-brand-success);
    }

    .alert-danger {
        background-color: rgba(229, 54, 26, 0.1);
        color: var(--color-brand-secondary);
        border-left: 4px solid var(--color-brand-secondary);
    }

    .alert-info {
        background-color: rgba(108, 117, 125, 0.1);
        color: var(--color-accent);
        border-left: 4px solid var(--color-accent);
    }

    .alert-light {
        background-color: rgba(248, 249, 250, 0.8);
        color: var(--color-text-dark);
        border-left: 4px solid var(--color-border);
    }

    /* MODALES ESTILO EDITORIAL */
    .modal-content {
        border-radius: var(--border-radius-lg);
        border: none;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
        background-color: var(--color-secondary);
        color: var(--color-text-light);
        font-family: var(--font-heading);
        font-weight: 700;
        border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
        padding: 1.5rem 2rem;
        border-bottom: 3px solid var(--color-brand-primary);
    }

    .modal-title {
        font-size: 1.4rem;
        font-weight: 700;
    }

    .modal-body {
        padding: 2rem;
    }

    .modal-footer {
        border-top: 1px solid var(--color-border);
        padding: 1.5rem 2rem;
        border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
    }

    /* FORMULARIOS ESTILO EDITORIAL */
    .form-control {
        border-radius: var(--border-radius-sm);
        border: 1px solid var(--color-border);
        padding: 0.75rem 1rem;
        font-family: var(--font-body);
        transition: all 0.3s ease;
    }

        .form-control:focus {
            border-color: var(--color-brand-primary);
            box-shadow: 0 0 0 0.2rem rgba(239, 136, 48, 0.25);
        }

    .form-label {
        font-family: var(--font-accent);
        font-weight: 600;
        color: var(--color-secondary);
        margin-bottom: 0.5rem;
    }

    .form-check-input:checked {
        background-color: var(--color-brand-primary);
        border-color: var(--color-brand-primary);
    }

    /* SEPARADORES MEJORADOS */
    .section-divider {
        border: none;
        height: 1px;
        background: linear-gradient(to right, transparent, var(--color-border), transparent);
        margin: 3rem 0;
    }

    /* ICONOS DE MANEJO */
    .handle {
        cursor: move;
        font-size: 1.2rem;
        color: var(--color-accent);
        transition: color 0.3s ease;
    }

        .handle:hover {
            color: var(--color-brand-primary);
        }

    /* RESPONSIVE ADJUSTMENTS */
    @@media (max-width: 991.98px) {
        .management-cover {
            height: 30vh;
        }

        .cover-overlay {
            padding: 2rem;
        }

        .cover-title {
            font-size: 2rem;
        }

        .cover-subtitle {
            font-size: 1.1rem;
        }

        .section-container {
            padding: 2rem 1.5rem;
            margin: 1.5rem 0;
        }

        .resource-card {
            margin-bottom: 1rem;
        }
    }

    @@media (max-width: 767.98px) {
        .management-cover {
            height: 25vh;
        }

        .cover-title {
            font-size: 1.75rem;
        }

        .section-title {
            font-size: 1.8rem;
        }

        .resource-title {
            font-size: 1.2rem;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
        }

        .modal-body {
            padding: 1.5rem;
        }
    }

    @@media (max-width: 575.98px) {
        .management-cover {
            height: 20vh;
        }

        .cover-overlay {
            padding: 1.5rem;
        }

        .cover-title {
            font-size: 1.5rem;
        }

        .section-container {
            padding: 1.5rem 1rem;
            margin: 1rem 0;
            border-radius: var(--border-radius-md);
        }

        .resource-header,
        .resource-body {
            padding: 1.25rem;
        }

        .btn-primary,
        .btn-success,
        .btn-secondary {
            padding: 0.625rem 1.25rem;
            font-size: 0.9rem;
        }
    }
</style>


<div class="container px-0 py-5 mb-5 pb-5">
    <!-- SECCIÓN PRINCIPAL DE GESTIÓN -->
    <div class="section-container">
        <!-- ENCABEZADO Y CONTROLES -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
            <div class="mb-3 mb-md-0">
                <span class="latest-grid-header">GESTIÓN DE RECURSOS</span>
                <p class="text-muted mt-2 mb-0">Añade contenido interactivo o de apoyo a este @tipoEntidad.</p>
            </div>

            <div class="d-flex flex-wrap gap-2">
                @if (tipoEntidad == "Curso")
                {
                    <a asp-action="GestionarCursos" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Volver a cursos
                    </a>
                }
                @if (tipoEntidad == "Modulo")
                {
                    <a asp-action="GestionarModulos" asp-route-cursoId="@cursoId" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Volver a módulos
                    </a>
                }
                @if (tipoEntidad == "Leccion")
                {
                    <button type="button" onclick="history.back()" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i> Volver atrás
                    </button>
                }

                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#crearRecursoModal">
                    <i class="fas fa-plus-circle me-2"></i> Nuevo recurso
                </button>
            </div>
        </div>

        <hr class="section-divider" />

        <!-- MENSAJES DE ESTADO -->
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">
                <i class="fas fa-check-circle me-2"></i> @TempData["SuccessMessage"]
            </div>
        }
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i> @TempData["ErrorMessage"]
            </div>
        }

        <!-- LISTA DE RECURSOS -->
        @if (Model == null || !Model.Any())
        {
            <div class="alert alert-info text-center" role="alert">
                <i class="fas fa-inbox fa-2x mb-3"></i>
                <h4>No hay recursos o actividades</h4>
                <p class="mb-0">¡Crea el primer elemento para comenzar!</p>
            </div>
        }
        else
        {
            <div class="alert alert-light d-flex justify-content-between align-items-center">
                <span>
                    <i class="fas fa-chart-bar me-2"></i>
                    Total de recursos/actividades: <strong>@Model.Count</strong>
                </span>
                <small class="text-muted">Arrastra para reordenar</small>
            </div>

            <div id="lista-recursos" class="mb-5">
                @foreach (var recurso in Model.OrderBy(r => r.Id))
                {
                    <div class="resource-card" data-id="@recurso.Id">
                        <div class="resource-header">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-arrows-alt handle me-3 text-muted flex-shrink-0" title="Arrastrar para reordenar"></i>
                                <div class="flex-grow-1">
                                    <h4 class="resource-title">@recurso.Titulo</h4>
                                    <div class="resource-meta">
                                        <span class="badge bg-primary me-2">@recurso.TipoRecurso</span>
                                        @if (recurso.RequiereEntrega)
                                        {
                                            <span class="badge bg-warning text-dark">Requiere entrega</span>
                                        }
                                    </div>
                                </div>
                                <div class="btn-group flex-shrink-0" role="group">
                                    <button type="button" class="btn btn-info btn-editar-recurso"
                                            data-id="@recurso.Id" title="Editar recurso">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="resource-body">
                            @if (!string.IsNullOrWhiteSpace(recurso.Url))
                            {
                                <div class="mb-3">
                                    <strong class="text-muted">URL:</strong>
                                    <a href="@recurso.Url" target="_blank" class="resource-url ms-2">
                                        <i class="fas fa-external-link-alt me-1"></i>@recurso.Url
                                    </a>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(recurso.Descripcion))
                            {
                                <div>
                                    <strong class="text-muted">Descripción:</strong>
                                    <p class="mb-0 mt-1">@Html.Raw(recurso.Descripcion)</p>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- MODALES (se mantienen igual funcionalmente) -->
<div class="modal fade" id="crearRecursoModal" tabindex="-1" aria-labelledby="crearRecursoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="crearRecursoModalLabel">Crear nuevo recurso o actividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formCrearRecurso" asp-action="CrearRecursoActividad" method="post" enctype="multipart/form-data" novalidate>
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div id="crear-recurso-validation-errors" class="alert alert-danger d-none"></div>

                    <input type="hidden" name="TipoEntidad" value="@tipoEntidad" />
                    <input type="hidden" name="EntidadId" value="@entidadId" />

                    <div class="form-group mb-3">
                        <label for="Crear_Titulo" class="form-label">Título del recurso/actividad</label>
                        <input type="text" id="Crear_Titulo" name="Titulo" class="form-control" required maxlength="255" />
                    </div>

                    <div class="form-group mb-3">
                        <label for="Crear_TipoRecurso" class="form-label">Tipo de recurso</label>
                        <select id="Crear_TipoRecurso" name="TipoRecurso" class="form-select" required>
                            <option value="" disabled selected>-- Seleccione tipo --</option>
                            @foreach (var item in tiposRecurso)
                            {
                                <option value="@item.Text">@item.Text</option>
                            }
                        </select>
                    </div>

                    <div id="seccion-url-archivo">
                        <div class="form-group mb-3">
                            <label for="Crear_Url" class="form-label">URL o enlace externo (si aplica)</label>
                            <input type="url" id="Crear_Url" name="Url" class="form-control" />
                        </div>

                        <div class="form-group mb-3">
                            <label for="Crear_Archivo" class="form-label">Subir archivo (PDF, ZIP, etc.)</label>
                            <input type="file" id="Crear_Archivo" name="Archivo" class="form-control" accept=".pdf,.doc,.docx,.zip,.rar" />
                            <small class="form-text text-muted">Deja vacío si usas un Enlace/URL.</small>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="Crear_Descripcion" class="form-label">Descripción (Opcional)</label>
                        <textarea id="Crear_Descripcion" name="Descripcion" class="form-control tinymce-descripcion" rows="5"></textarea>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="Crear_RequiereEntrega" name="RequiereEntrega" class="form-check-input" value="true">
                        <label class="form-check-label" for="Crear_RequiereEntrega">Requiere entrega del estudiante (Marcar para actividades evaluables)</label>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success" id="btnGuardarRecurso">Guardar Recurso</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editarRecursoModal" tabindex="-1" aria-labelledby="editarRecursoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarRecursoModalLabel">Editar recurso o actividad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="formEditarRecurso" asp-action="EditarRecursoActividad" method="post" enctype="multipart/form-data" novalidate>
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div id="editar-recurso-validation-errors" class="alert alert-danger d-none"></div>

                    <input type="hidden" id="Editar_Id" name="Id" value="" />
                    <input type="hidden" id="Editar_TipoEntidad" name="TipoEntidad" value="" />
                    <input type="hidden" id="Editar_EntidadId" name="EntidadId" value="" />

                    <div class="form-group mb-3">
                        <label for="Editar_Titulo" class="form-label">Título del recurso/actividad</label>
                        <input type="text" id="Editar_Titulo" name="Titulo" class="form-control" required maxlength="255" />
                    </div>

                    <div class="form-group mb-3">
                        <label for="Editar_TipoRecurso" class="form-label">Tipo de Recurso</label>
                        <select id="Editar_TipoRecurso" name="TipoRecurso" class="form-select" required>
                            <option value="" disabled selected>-- Seleccione tipo --</option>
                            @foreach (var item in tiposRecurso)
                            {
                                <option value="@item.Text">@item.Text</option>
                            }
                        </select>
                    </div>

                    <div id="seccion-url-archivo-editar">
                        <div class="form-group mb-3">
                            <label for="Editar_Url" class="form-label">URL o enlace externo (si aplica)</label>
                            <input type="text" id="Editar_Url" name="Url" class="form-control" />
                        </div>

                        <div class="form-group mb-3">
                            <label for="Editar_Archivo" class="form-label">Reemplazar archivo</label>
                            <input type="file" id="Editar_Archivo" name="Archivo" class="form-control" accept=".pdf,.doc,.docx,.zip,.rar" />
                            <small class="form-text text-muted">Subir un nuevo archivo reemplazará el actual.</small>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label for="Editar_Descripcion" class="form-label">Descripción (Opcional)</label>
                        <textarea id="Editar_Descripcion" name="Descripcion" class="form-control tinymce-descripcion" rows="5"></textarea>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" id="Editar_RequiereEntrega" name="RequiereEntrega" class="form-check-input" value="true">
                        <label class="form-check-label" for="Editar_RequiereEntrega">Requiere entrega del estudiante</label>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnGuardarEdicion">Guardar cambios</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/72k2eqfy02quriyevi4t2ctxtg50ucyx8gngemudhw0tyn9w/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        // Función clave para permitir que TinyMCE funcione dentro de un modal de Bootstrap (problema de foco)
        function tinymceModalSetup(editor) {
            editor.on('init', function() {
                // Cuando el modal de Bootstrap se muestra:
                $(editor.getContainer()).parents('.modal').on('shown.bs.modal', function () {
                    editor.focus();
                });
            });
        }

        // Función para inicializar o re-inicializar el editor
        function initTinyMCE(selector, content = '') {
            var editorId = selector.replace('#', '');

            // 1. Si existe una instancia de TinyMCE para ese ID, la destruimos.
            if (tinymce.get(editorId)) {
                tinymce.get(editorId).remove();
            }

            // 2. Inicializamos una nueva instancia.
            tinymce.init({
                selector: selector,
                plugins: 'advlist autolink lists link image charmap preview anchor searchreplace visualblocks code fullscreen insertdatetime media table help wordcount',
                toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
                height: 300,
                setup: function (editor) {
                    tinymceModalSetup(editor); // Aplicar la corrección de foco
                    editor.on('init', function (e) {
                        // Establecer el contenido SÓLO después de que el editor se haya inicializado
                        if (content) {
                            editor.setContent(content);
                        } else {
                            editor.setContent('');
                        }
                    });
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {

            // --- Inicialización de TinyMCE al cargar la página ---
            initTinyMCE('#Crear_Descripcion');

            // --- Referencias a Elementos ---
            const crearForm = document.getElementById('formCrearRecurso');
            const btnGuardarCrear = document.getElementById('btnGuardarRecurso');
            const tipoRecursoSelectCrear = document.getElementById('Crear_TipoRecurso');
            const seccionUrlArchivoCrear = document.getElementById('seccion-url-archivo');
            const requiereEntregaCheckboxCrear = document.getElementById('Crear_RequiereEntrega');

            const editarForm = document.getElementById('formEditarRecurso');
            const btnGuardarEdicion = document.getElementById('btnGuardarEdicion');
            const tipoRecursoSelectEditar = document.getElementById('Editar_TipoRecurso');
            const seccionUrlArchivoEditar = document.getElementById('seccion-url-archivo-editar');
            const requiereEntregaCheckboxEditar = document.getElementById('Editar_RequiereEntrega');

            const controladorName = "Admin"; // Ajusta esto al nombre real de tu controlador

            // --- Utilidades ---

            function getAntiForgeryToken() {
                const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                return tokenElement ? tokenElement.value : '';
            }

            function displayErrors(errorDivId, errors) {
                const errorDiv = document.getElementById(errorDivId);
                errorDiv.innerHTML = '';
                errorDiv.classList.add('d-none');

                const errorList = [];
                const errorSource = errors.errors || errors; // Si viene del servidor, 'errors' puede estar anidado

                if (typeof errorSource === 'object' && errorSource !== null) {
                    for (const key in errorSource) {
                        if (errorSource.hasOwnProperty(key) && Array.isArray(errorSource[key])) {
                            errorSource[key].forEach(error => {
                                // Intenta hacer el nombre de campo más legible
                                const fieldName = key.includes('.') ? key.split('.').pop() : key;
                                errorList.push(`<div><strong>${fieldName}:</strong> ${error}</div>`);
                            });
                        } else if (key === 'message') {
                            errorList.push(`<div>${errorSource[key]}</div>`);
                        }
                    }
                } else if (typeof errors.message === 'string') {
                    errorList.push(`<div>${errors.message}</div>`);
                } else if (typeof errors === 'string') {
                    errorList.push(`<div>${errors}</div>`);
                }

                if (errorList.length > 0) {
                    errorDiv.innerHTML = errorList.join('');
                    errorDiv.classList.remove('d-none');
                }
            }

            function setupTipoRecursoLogic(selectElement, urlArchivoSection, requiereEntregaCheckbox) {
                const updateVisibility = () => {
                    const selectedValue = selectElement.value;
                    const isActivity = selectedValue === "Actividad";

                    urlArchivoSection.style.display = isActivity ? 'none' : 'block';

                    const entregaContainer = requiereEntregaCheckbox.closest('.form-check');
                    // Muestra/Oculta la opción de Requiere Entrega (generalmente solo para Actividad)
                    if (isActivity) {
                        entregaContainer.style.display = 'block';
                    } else {
                        entregaContainer.style.display = 'none';
                        // Desmarca si se cambia de tipo, ya que no aplica
                        requiereEntregaCheckbox.checked = false;
                    }
                };

                selectElement.addEventListener('change', updateVisibility);
                updateVisibility(); // Llamar al cargar para establecer el estado inicial
            }

            // --- 1. Lógica de UI (Creación y Edición) ---
            setupTipoRecursoLogic(tipoRecursoSelectCrear, seccionUrlArchivoCrear, requiereEntregaCheckboxCrear);
            setupTipoRecursoLogic(tipoRecursoSelectEditar, seccionUrlArchivoEditar, requiereEntregaCheckboxEditar);


            // --- 2. Funciones CRUD Asíncronas ---

            // A. CREAR RECURSO
            crearForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Asegúrate de que TinyMCE guarde su contenido en el textarea antes de crear FormData
                if (tinymce.get('Crear_Descripcion')) {
                    tinymce.get('Crear_Descripcion').save();
                }

                btnGuardarCrear.disabled = true;
                btnGuardarCrear.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

                const formData = new FormData(this);

                if (!document.getElementById('Crear_RequiereEntrega').checked) {
                    formData.append('RequiereEntrega', 'false');
                }

                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData // FormData incluye Content-Type: multipart/form-data
                    });

                    const jsonResponse = await response.json();

                    if (jsonResponse.success) {
                        // Éxito
                        const modal = bootstrap.Modal.getInstance(document.getElementById('crearRecursoModal'));
                        modal.hide();
                        Swal.fire('Creado!', jsonResponse.message, 'success')
                            .then(() => window.location.reload());
                    } else {
                        // Error de Validación o de Servidor
                        displayErrors('crear-recurso-validation-errors', jsonResponse);
                        Swal.fire('Error', jsonResponse.message || 'Error al crear el recurso.', 'error');
                    }
                } catch (error) {
                    Swal.fire('Error de Conexión', 'No se pudo contactar al servidor. Revise su conexión.', 'error');
                    console.error('Error de Creación:', error);
                } finally {
                    btnGuardarCrear.disabled = false;
                    btnGuardarCrear.innerHTML = 'Guardar Recurso';
                }
            });

            // B. CARGAR RECURSO PARA EDICIÓN
            async function cargarRecursoParaEdicion(recursoId) {
                try {
                    const response = await fetch(`/${controladorName}/ObtenerRecursoParaEdicion?id=${recursoId}`);
                    const jsonResponse = await response.json();

                    if (jsonResponse.success && jsonResponse.data) {
                        const data = jsonResponse.data;

                        document.getElementById('editar-recurso-validation-errors').classList.add('d-none');
                        // Llenar campos
                        document.getElementById('Editar_Id').value = data.id;
                        document.getElementById('Editar_TipoEntidad').value = data.tipoEntidad;
                        document.getElementById('Editar_EntidadId').value = data.entidadId;
                        document.getElementById('Editar_Titulo').value = data.titulo;
                        document.getElementById('Editar_Url').value = data.url || '';
                        document.getElementById('Editar_TipoRecurso').value = data.tipoRecurso;
                        document.getElementById('Editar_RequiereEntrega').checked = data.requiereEntrega;

                        // CAMBIO CLAVE: Inicializar TinyMCE con el contenido cargado
                        const descripcionContent = data.descripcion || '';
                        initTinyMCE('#Editar_Descripcion', descripcionContent);

                        // Necesario para que la lógica de visibilidad se active
                        tipoRecursoSelectEditar.dispatchEvent(new Event('change'));

                        const modal = new bootstrap.Modal(document.getElementById('editarRecursoModal'));
                        modal.show();

                    } else {
                        Swal.fire('Error de Carga', jsonResponse.message || 'No se pudo obtener la información del recurso.', 'error');
                    }
                } catch (error) {
                    Swal.fire('Error de Conexión', 'No se pudo obtener la información del recurso. Revise la consola.', 'error');
                    console.error('Error de Carga:', error);
                }
            }

            // C. EDITAR RECURSO
            editarForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Asegúrate de que TinyMCE guarde su contenido en el textarea
                if (tinymce.get('Editar_Descripcion')) {
                    tinymce.get('Editar_Descripcion').save();
                }

                btnGuardarEdicion.disabled = true;
                btnGuardarEdicion.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Guardando...';

                const formData = new FormData(this);
                // El token de antiforgery se añade automáticamente en FormData
                if (!document.getElementById('Editar_RequiereEntrega').checked) {
                    formData.append('RequiereEntrega', 'false');
                }

                try {
                    const response = await fetch(this.action, {
                        method: 'POST',
                        body: formData
                    });

                    const jsonResponse = await response.json();

                    if (jsonResponse.success) {
                        // Éxito
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editarRecursoModal'));
                        modal.hide();
                        Swal.fire('Actualizado!', jsonResponse.message, 'success')
                            .then(() => window.location.reload());
                    } else {
                        // Error de Validación o de Servidor
                        displayErrors('editar-recurso-validation-errors', jsonResponse);
                        Swal.fire('Error', jsonResponse.message || 'Error al actualizar el recurso. Revise los errores de validación.', 'error');
                    }
                } catch (error) {
                    Swal.fire('Error de Conexión', 'No se pudo contactar al servidor. Revise su conexión.', 'error');
                    console.error('Error de Edición:', error);
                } finally {
                    btnGuardarEdicion.disabled = false;
                    btnGuardarEdicion.innerHTML = 'Guardar Cambios';
                }
            });

            // D. ELIMINAR RECURSO
            async function confirmarEliminacion(recursoId) {
                const result = await Swal.fire({
                    title: '¿Estás seguro?',
                    text: "¡Eliminar este recurso también borrará las entregas asociadas de los estudiantes! No podrás revertir esto.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                });

                if (result.isConfirmed) {
                    try {
                        const token = getAntiForgeryToken();

                        const data = new FormData();
                        data.append('id', recursoId);
                        data.append('__RequestVerificationToken', token); // Añadir el token al FormData

                        const response = await fetch(`/${controladorName}/EliminarRecursoActividad`, {
                            method: 'POST',
                            body: data
                        });

                        const jsonResponse = await response.json();

                        if (jsonResponse.success) {
                            Swal.fire('Eliminado!', jsonResponse.message, 'success')
                                .then(() => window.location.reload());
                        } else {
                            Swal.fire('Error', jsonResponse.message, 'error');
                        }
                    } catch (error) {
                        Swal.fire('Error de Red', 'No se pudo conectar con el servidor.', 'error');
                        console.error('Error de Eliminación:', error);
                    }
                }
            }

            // --- 3. Event Listeners para la lista de recursos (Delegación) ---
            const listaRecursos = document.getElementById('lista-recursos');
            if (listaRecursos) {
                // Configuración de Sortable (Arrastrar y Soltar)
                new Sortable(listaRecursos, {
                    animation: 150,
                    handle: '.handle',
                    // Si planeas implementar el reordenamiento en el backend:
                    // onEnd: function (evt) {
                    //    const ordenIds = Array.from(evt.from.children).map(item => item.dataset.id);
                    //    // Llama a una función AJAX para guardar el nuevo orden
                    //    // guardarNuevoOrden(ordenIds);
                    // }
                });

                // Manejo de Clics en los botones de la lista
                listaRecursos.addEventListener('click', function(e) {
                    const btn = e.target.closest('.btn-editar-recurso, .btn-eliminar-recurso');
                    if (!btn) return;

                    const id = btn.dataset.id;

                    if (btn.classList.contains('btn-editar-recurso')) {
                        e.preventDefault();
                        cargarRecursoParaEdicion(id);
                    } else if (btn.classList.contains('btn-eliminar-recurso')) {
                        e.preventDefault();
                        confirmarEliminacion(id);
                    }
                });
            }
        });
    </script>
}