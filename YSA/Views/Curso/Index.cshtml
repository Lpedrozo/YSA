@model YSA.Web.Models.ViewModels.CursosIndexViewModel
@{
    ViewData["Title"] = "Cursos | Yo Soy Arte";
}

<div class="container-sin-gutter cursos-index-container">
    @* =========================================== *@
    @* HERO SECTION CON BÚSQUEDA, FILTROS Y CATEGORÍAS *@
    @* =========================================== *@
    <div class="cursos-hero-section" style="background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('/diseño/BannerYSA.png');">
        <div class="container py-5">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="hero-content text-center text-white mb-5">
                        <h1 class="display-4 fw-bold mb-4" style="font-family: var(--font-heading);">
                            Explora nuestra <span class="text-brand-primary">colección de cursos</span>
                        </h1>
                        <p class="lead mb-5" style="font-size: 1.25rem;">
                            Descubre más de @(Model.CursosDestacados?.Count() + Model.CursosRecomendados?.Count() ?? 0) cursos diseñados para potenciar tu creatividad
                        </p>
                    </div>

                    @* BÚSQUEDA Y FILTROS *@
                    <div class="search-section bg-white p-4 rounded-lg shadow-lg mb-5">
                        @* Formulario de búsqueda *@
                        <div class="search-form mb-4">
                            <div class="input-group input-group-lg shadow-sm">
                                <span class="input-group-text bg-white border-end-0">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text"
                                       class="form-control border-start-0 py-3"
                                       placeholder="Buscar cursos por título, instructor o palabra clave..."
                                       id="searchInput">
                                <button class="btn btn-primary px-4" type="button" id="searchButton">
                                    <i class="fas fa-search me-2"></i>Buscar
                                </button>
                            </div>
                        </div>

                        @* Filtros rápidos *@
                        <div class="filters-section">
                            <div class="d-flex flex-wrap justify-content-center align-items-center gap-3">
                                <span class="text-muted fw-medium">Filtrar por:</span>
                                <select class="form-select form-select-sm w-auto border-0 bg-light" id="nivelFilter">
                                    <option value="">Todos los niveles</option>
                                    <option value="0">Principiante</option>
                                    <option value="1">Intermedio</option>
                                    <option value="2">Avanzado</option>
                                </select>
                                <select class="form-select form-select-sm w-auto border-0 bg-light" id="precioFilter">
                                    <option value="">Cualquier precio</option>
                                    <option value="gratis">Gratis</option>
                                    <option value="0-50">Hasta $50</option>
                                    <option value="50-100">$50 - $100</option>
                                    <option value="100+">Más de $100</option>
                                </select>
                                <select class="form-select form-select-sm w-auto border-0 bg-light" id="ordenFilter">
                                    <option value="recientes">Más recientes</option>
                                    <option value="destacados">Destacados</option>
                                    <option value="precio-asc">Precio: menor a mayor</option>
                                    <option value="precio-desc">Precio: mayor a menor</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    @* CATEGORÍAS *@
                    <div class="categories-section bg-white p-4 rounded-lg shadow-lg">
                        <div class="row align-items-center mb-4">
                            <div class="col-md-8">
                                <h2 class="h4 mb-0" style="font-family: var(--font-heading);">
                                    Explora por <span class="text-brand-primary">categorías</span>
                                </h2>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <span class="text-muted small">@(Model.CategoriasDisponibles?.Count() ?? 0) categorías disponibles</span>
                            </div>
                        </div>

                        <div class="categories-grid">
                            @* Categoría "Todos" *@
                            <a href="#" class="category-card text-decoration-none active" data-categoria="">
                                <div class="category-icon mb-3">
                                    <i class="fas fa-globe fa-2x"></i>
                                </div>
                                <h3 class="h6 mb-2">Todos</h3>
                                <span class="badge bg-light text-dark small">Ver todos</span>
                            </a>

                            @* Categorías disponibles *@
                            @if (Model.CategoriasDisponibles != null && Model.CategoriasDisponibles.Any())
                            {
                                foreach (var categoria in Model.CategoriasDisponibles)
                                {
                                    <a href="#" class="category-card text-decoration-none" data-categoria="@categoria">
                                        <div class="category-icon mb-3">
                                            <i class="fas fa-palette fa-2x"></i>
                                        </div>
                                        <h3 class="h6 mb-2">@categoria</h3>
                                        <span class="badge bg-light text-dark small">Ver cursos</span>
                                    </a>
                                }
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* =========================================== *@
    @* CONTENIDO PRINCIPAL DE CURSOS *@
    @* =========================================== *@
    <div class="container py-5">
        @* SECCIÓN DE TODOS LOS CURSOS *@
        <div class="row">
            <div class="col-12">
                <div class="all-courses-section pb-5 mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="h3" style="font-family: var(--font-heading);">
                                <span class="text-brand-primary">Todos los cursos</span>
                                <small class="text-muted fs-6 ms-2" id="totalCursos"></small>
                            </h2>
                            <p class="text-muted small mb-0" id="filterStatus">
                                Mostrando todos los cursos disponibles
                            </p>
                        </div>
                        <div class="loading-spinner small d-none" id="loadingSpinner">
                            <i class="fas fa-spinner fa-spin"></i> Cargando...
                        </div>
                    </div>

                    @* Contenedor para cursos cargados por AJAX *@
                    <div id="cursosContainer" class="row g-4">
                        @* Los cursos se cargarán aquí dinámicamente *@
                    </div>

                    @* Paginación *@
                    <nav aria-label="Paginación de cursos" class="mt-5">
                        <ul class="pagination justify-content-center" id="paginationContainer">
                            @* La paginación se generará dinámicamente *@
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@* Overlay de carga *@
<div class="loading-overlay">
    <div class="loading-spinner"></div>
</div>

@section Scripts {
    <script>
        // Variables globales
        let currentPage = 1;
        let totalPages = 1;
        let isLoading = false;
        let currentCategory = '';
        let currentSearch = '';
        let currentNivel = '';
        let currentPrecio = '';
        let currentOrden = 'recientes';

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar cursos iniciales
            loadCursos(1);

            // Configurar eventos
            setupEventListeners();

            // Actualizar contador inicial
            updateTotalCount();
            updateFilterStatus();
        });

        // Configurar event listeners
        function setupEventListeners() {
            // Búsqueda
            document.getElementById('searchButton').addEventListener('click', function() {
                currentSearch = document.getElementById('searchInput').value;
                loadCursos(1);
            });

            document.getElementById('searchInput').addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    currentSearch = this.value;
                    loadCursos(1);
                }
            });

            // Filtros
            document.getElementById('nivelFilter').addEventListener('change', function() {
                currentNivel = this.value;
                loadCursos(1);
            });

            document.getElementById('precioFilter').addEventListener('change', function() {
                currentPrecio = this.value;
                loadCursos(1);
            });

            document.getElementById('ordenFilter').addEventListener('change', function() {
                currentOrden = this.value;
                loadCursos(1);
            });

            // Categorías
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Actualizar categoría activa
                    document.querySelectorAll('.category-card').forEach(c => {
                        c.classList.remove('active');
                    });
                    this.classList.add('active');

                    // Cambiar categoría
                    currentCategory = this.getAttribute('data-categoria');
                    loadCursos(1);
                });
            });
        }

        // Cargar cursos con AJAX
        async function loadCursos(page = 1) {
            if (isLoading) return;

            isLoading = true;
            showLoading();

            try {
                // Construir parámetros
                const params = new URLSearchParams();
                if (currentCategory) params.append('categoria', currentCategory);
                if (currentSearch) params.append('searchString', currentSearch);
                if (currentNivel) params.append('nivel', currentNivel);
                if (currentPrecio) params.append('precio', currentPrecio);
                if (currentOrden) params.append('orden', currentOrden);
                params.append('page', page);

                // Hacer la solicitud
                const response = await fetch(`@Url.Action("ObtenerCursosJson", "Curso")?${params}`);

                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }

                const data = await response.json();

                // Renderizar cursos
                renderCursos(data.cursos);

                // Actualizar paginación
                currentPage = page;
                totalPages = data.totalPaginas;
                renderPagination();

                // Actualizar URL
                updateUrl(params);

                // Actualizar contadores
                updateTotalCount(data.cursos.length, data.totalCursos);
                updateFilterStatus();

            } catch (error) {
                console.error('Error al cargar cursos:', error);
                showError('Error al cargar los cursos. Por favor, intente nuevamente.');
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

                // Renderizar cursos - SOLO IMAGEN Y PRECIO (1080x1350)
                // Renderizar cursos - SOLO IMAGEN Y PRECIO (1080x1350)
        function renderCursos(cursos) {
            const container = document.getElementById('cursosContainer');

            if (!cursos || cursos.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-book-open fa-4x text-muted mb-4"></i>
                        <h4 class="mb-3">No se encontraron cursos</h4>
                        <p class="text-muted mb-0">Intenta con otros criterios de búsqueda.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = cursos.map(curso => {
                // Extraer el número y formatearlo
                let precioFormateado = curso.precio;

                if (typeof curso.precio === 'string' && curso.precio.includes('Bs.S')) {
                    // Extraer el número después de "Bx.S"
                    const numero = parseFloat(curso.precio.replace('Bs.S', '').trim());
                    precioFormateado = `$${numero.toFixed(2)}`;
                }

                const esGratis = precioFormateado === '$0.00' ||
                                 curso.precio === 0 ||
                                 curso.precio === '0';

                return `
                    <div class="col-lg-4 col-md-6">
                        <a href="@Url.Action("Detalles", "Curso")/${curso.id}" class="course-card">
                            <div class="course-card-header position-relative">
                                <img src="${curso.urlImagen || '/diseño/default-course.jpg'}"
                                     class="course-image"
                                     alt="${curso.titulo}"
                                     loading="lazy"
                                     onerror="this.src='/diseño/default-course.jpg'">
                                ${esGratis ?
                                    '<span class="badge-free">GRATIS</span>' :
                                    `<span class="badge-price">${precioFormateado}</span>`}
                            </div>
                        </a>
                    </div>
                `;
            }).join('');
        }

        // Renderizar paginación
        function renderPagination() {
            const container = document.getElementById('paginationContainer');

            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';

            // Botón anterior
            html += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;

            // Números de página
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            // Botón siguiente
            html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            container.innerHTML = html;
        }

        // Cambiar página
        function changePage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            loadCursos(page);
        }

        // Actualizar URL
        function updateUrl(params) {
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({}, '', newUrl);
        }

        // Actualizar contador total
        function updateTotalCount(currentCount = 0, totalCount = 0) {
            const element = document.getElementById('totalCursos');
            if (element) {
                if (totalCount > 0) {
                    element.textContent = `(${currentCount} de ${totalCount} cursos)`;
                } else {
                    element.textContent = `(${currentCount} cursos)`;
                }
            }
        }

        // Actualizar estado de filtros
        function updateFilterStatus() {
            const statusElement = document.getElementById('filterStatus');
            let statusText = 'Mostrando todos los cursos disponibles';

            if (currentCategory) {
                statusText = `Categoría: ${currentCategory}`;
            }
            if (currentSearch) {
                statusText = `Búsqueda: "${currentSearch}"`;
            }
            if (currentNivel) {
                const nivelText = document.getElementById('nivelFilter').options[document.getElementById('nivelFilter').selectedIndex].text;
                statusText = `Nivel: ${nivelText}`;
            }
            if (currentPrecio) {
                const precioText = document.getElementById('precioFilter').options[document.getElementById('precioFilter').selectedIndex].text;
                statusText = `Precio: ${precioText}`;
            }

            statusElement.textContent = statusText;
        }

        // Mostrar/ocultar loading
        function showLoading() {
            document.querySelector('.loading-overlay').style.display = 'flex';
            document.getElementById('loadingSpinner').classList.remove('d-none');
        }

        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
            document.getElementById('loadingSpinner').classList.add('d-none');
        }

        // Mostrar error
        function showError(message) {
            const container = document.getElementById('cursosContainer');
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${message}
                    </div>
                </div>
            `;
        }

        // Manejar navegación con botones atrás/adelante
        window.addEventListener('popstate', function() {
            const urlParams = new URLSearchParams(window.location.search);

            // Actualizar valores de filtros desde URL
            currentCategory = urlParams.get('categoria') || '';
            currentSearch = urlParams.get('searchString') || '';
            currentNivel = urlParams.get('nivel') || '';
            currentPrecio = urlParams.get('precio') || '';
            currentOrden = urlParams.get('orden') || 'recientes';
            const page = parseInt(urlParams.get('page')) || 1;

            // Actualizar controles UI
            document.getElementById('searchInput').value = currentSearch;
            document.getElementById('nivelFilter').value = currentNivel;
            document.getElementById('precioFilter').value = currentPrecio;
            document.getElementById('ordenFilter').value = currentOrden;

            // Actualizar categoría activa
            document.querySelectorAll('.category-card').forEach(card => {
                const cat = card.getAttribute('data-categoria');
                if (cat === currentCategory) {
                    card.classList.add('active');
                } else {
                    card.classList.remove('active');
                }
            });

            // Cargar cursos
            loadCursos(page);
        });
    </script>
}