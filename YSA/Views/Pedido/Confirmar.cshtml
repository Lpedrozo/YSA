@model YSA.Web.Models.ViewModels.ConfirmacionPagoViewModel
@using System.Globalization;
@{
    ViewData["Title"] = "Confirmar pago";

    // Configuración de culturas
    var cultureUS = new CultureInfo("en-US");
    var cultureVE = new CultureInfo("es-VE");

    // Cálculo del total en VES
    decimal totalVes = Model.TasaBCV > 0 ? Model.Total * Model.TasaBCV.Value : 0;

    // Datos para WhatsApp
    var whatsappNumber = "584241544523";
    var whatsappMessage = $"Hola, necesito asistencia con el pago del Pedido #{Model.PedidoId}. ¿Me pueden ayudar?";
    var encodedMessage = System.Web.HttpUtility.UrlEncode(whatsappMessage);
    var whatsappLink = $"https://wa.me/{whatsappNumber}?text={encodedMessage}";
}

<!-- Hero de confirmación -->
<div class="confirmacion-hero">
    <img src="/diseño/HeaderAcademia.jpg" class="confirmacion-hero-imagen" alt="Confirmación de pago">
    <div class="confirmacion-hero-overlay">
        <div class="confirmacion-hero-contenido">
            <span class="confirmacion-hero-badge">CONFIRMACIÓN DE PAGO</span>
            <h1 class="confirmacion-hero-titulo">Finaliza tu compra</h1>
            <p class="confirmacion-hero-subtitulo">Registra tu pago y únete a nuestra comunidad artística</p>
        </div>
    </div>
</div>

<div class="container px-0 py-5">
    <!-- Mensajes de error -->
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger mb-4">
            <i class="fas fa-exclamation-circle me-2"></i> @TempData["Error"]
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-warning mb-4">
            <i class="fas fa-exclamation-triangle me-2"></i> @TempData["ErrorMessage"]
        </div>
    }

    <!-- Contenido principal -->
    <div class="row g-4">
        <!-- Formulario de pago -->
        <div class="col-lg-6">
            <div class="confirmacion-tarjeta h-100">
                <div class="confirmacion-tarjeta-header">
                    <i class="fas fa-credit-card"></i> Registrar pago y comprobante
                </div>
                <div class="confirmacion-tarjeta-body">
                    <form asp-controller="Pedido" asp-action="ProcesarPago" method="post" enctype="multipart/form-data">
                        <input type="hidden" name="pedidoId" value="@Model.PedidoId" />

                        <!-- Método de pago -->
                        <div class="mb-4">
                            <label for="MetodoPago" class="confirmacion-form-label">
                                <i class="fas fa-money-check-alt"></i> Método de pago
                            </label>
                            <select class="form-control confirmacion-form-select" id="MetodoPago" name="metodoPago" required>
                                <option value="" disabled selected>Seleccione un método</option>
                                <option value="Transferencia Bancaria">Transferencia Bancaria</option>
                                <option value="Pago Móvil">Pago Móvil</option>
                                <option value="PayPal">PayPal</option>
                            </select>
                        </div>

                        <!-- Información de pago dinámica -->
                        <div id="confirmacion-info-caja" class="confirmacion-info-caja" style="display:none;">
                            <h4 class="confirmacion-info-titulo">
                                <i class="fas fa-info-circle"></i> Datos para realizar el pago
                            </h4>
                            <div id="confirmacion-info-detalle">
                                <!-- La información se cargará dinámicamente aquí -->
                            </div>
                        </div>

                        <!-- Referencia de pago -->
                        <div class="mb-4">
                            <label for="ReferenciaPago" class="confirmacion-form-label">
                                <i class="fas fa-hashtag"></i> Referencia del pago
                            </label>
                            <input type="text" class="form-control confirmacion-form-input"
                                   id="ReferenciaPago"
                                   name="referenciaPago"
                                   placeholder="Ingrese N° de transacción o Hash"
                                   required>
                        </div>

                        <!-- Comprobante -->
                        <div class="mb-4">
                            <label for="comprobanteArchivo" class="confirmacion-form-label">
                                <i class="fas fa-file-upload"></i> Subir comprobante
                            </label>
                            <input type="file" class="form-control confirmacion-form-file"
                                   id="comprobanteArchivo"
                                   name="comprobanteArchivo"
                                   accept=".pdf,.jpg,.jpeg,.png"
                                   required>
                            <div class="form-text">Formatos aceptados: PDF, JPG, PNG (Máx. 5MB)</div>
                        </div>

                        <!-- Botón de envío -->
                        <button type="submit" class="btn confirmacion-btn-enviar">
                            <i class="fas fa-paper-plane me-2"></i> Enviar comprobante
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Resumen del pedido -->
        <div class="col-lg-6">
            <div class="confirmacion-tarjeta h-100">
                <div class="confirmacion-tarjeta-header">
                    <i class="fas fa-receipt"></i> Resumen del pedido
                </div>
                <div class="confirmacion-tarjeta-body">
                    <h3 class="confirmacion-resumen-titulo">Pedido #@Model.PedidoId</h3>

                    <!-- Lista de artículos -->
                    <ul class="confirmacion-lista-articulos">
                        @foreach (var articulo in Model.Articulos)
                        {
                            <li class="confirmacion-articulo-item">
                                <div class="confirmacion-articulo-nombre">@articulo.TituloItem</div>
                                <div class="confirmacion-articulo-precio">@articulo.Precio.ToString("N2", cultureUS) USD</div>
                            </li>
                        }
                    </ul>

                    <!-- Total -->
                    <div class="confirmacion-total-box">
                        <div class="confirmacion-total-item">
                            <div class="confirmacion-total-label">Total en dólares:</div>
                            <div class="confirmacion-total-usd">@Model.Total.ToString("N2", cultureUS) USD</div>
                        </div>

                        <div class="confirmacion-info-divider"></div>

                        <div class="confirmacion-total-item">
                            <div class="confirmacion-total-label">Total a pagar:</div>
                            <div class="confirmacion-total-ves">@totalVes.ToString("N2", cultureVE) VES</div>
                        </div>

                        <span class="confirmacion-tasa">
                            <i class="fas fa-exchange-alt me-1"></i>
                            Tasa BCV: @Model.TasaBCV.Value.ToString("N4", cultureUS) VES/USD
                        </span>
                    </div>

                    <!-- Botón de WhatsApp -->
                    <div class="d-grid mt-4">
                        <a href="@whatsappLink" target="_blank" class="btn confirmacion-btn-whatsapp">
                            <i class="fab fa-whatsapp"></i>
                            Pagar o consultar por WhatsApp
                        </a>
                    </div>

                    <!-- Información adicional -->
                    <div class="alert alert-info mt-4 mb-0 p-3">
                        <i class="fas fa-clock me-2"></i>
                        Una vez enviado el comprobante, validaremos el pago en un máximo de 24 horas. Recibirás un correo de confirmación.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección de ayuda -->
    <div class="confirmacion-ayuda-seccion">
        <h2 class="confirmacion-ayuda-titulo">¿Necesitas ayuda?</h2>
        <p class="confirmacion-ayuda-descripcion">
            Nuestro equipo de soporte está disponible para ayudarte con cualquier duda sobre tu pago o pedido.
        </p>

        <div class="row g-4">
            <div class="col-md-4">
                <div class="confirmacion-icono-card">
                    <div class="confirmacion-icono-grande" style="color: var(--color-brand-primary);">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h4 class="confirmacion-icono-titulo">Soporte Inmediato</h4>
                    <p class="confirmacion-icono-texto">Contacta por WhatsApp para asistencia rápida</p>
                </div>
            </div>

            <div class="col-md-4">
                <div class="confirmacion-icono-card">
                    <div class="confirmacion-icono-grande" style="color: var(--color-brand-success);">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h4 class="confirmacion-icono-titulo">Pago Seguro</h4>
                    <p class="confirmacion-icono-texto">Todas las transacciones son verificadas y seguras</p>
                </div>
            </div>

            <div class="col-md-4">
                <div class="confirmacion-icono-card">
                    <div class="confirmacion-icono-grande" style="color: var(--color-brand-secondary);">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <h4 class="confirmacion-icono-titulo">Confirmación por Email</h4>
                    <p class="confirmacion-icono-texto">Recibirás confirmación detallada de tu compra</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            // Variables con formato para USD, VES y Tasa
            const formattedTotalUSD = '@Html.Raw(Model.Total.ToString("N2", cultureUS))';
            const formattedTotalVES = '@Html.Raw(totalVes.ToString("N2", cultureVE))';
            const tasaHoy = '@Model.TasaBCV.Value.ToString("N4", cultureUS)';

            // Información de pago por método
            const PAYMENT_DETAILS = {
                "Transferencia Bancaria": `
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Monto a Pagar:</span>
                        <span class="confirmacion-info-valor text-success fw-bold">${formattedTotalVES} VES</span>
                    </div>
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Tasa Aplicada:</span>
                        <span class="confirmacion-info-valor">${tasaHoy} VES/USD</span>
                    </div>

                    <div class="confirmacion-info-divider"></div>

                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Banco:</span>
                        <span class="confirmacion-info-valor">Banco Universal Monocromático</span>
                    </div>
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">RUC/C.I.:</span>
                        <span class="confirmacion-info-valor">V-12.345.678</span>
                    </div>
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">N° Cuenta:</span>
                        <span class="confirmacion-info-valor">0102-0304-0506-0708-0910</span>
                    </div>
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Correo:</span>
                        <span class="confirmacion-info-valor">pagos@yosoyarte.com</span>
                    </div>
                `,
                "Pago Móvil": `
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Monto a Pagar:</span>
                        <span class="confirmacion-info-valor text-success fw-bold">${formattedTotalVES} VES</span>
                    </div>
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Tasa Aplicada:</span>
                        <span class="confirmacion-info-valor">${tasaHoy} VES/USD</span>
                    </div>

                    <div class="confirmacion-info-divider"></div>

                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Banco:</span>
                        <span class="confirmacion-info-valor">Banco Móvil Digital</span>
                    </div>
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">C.I.:</span>
                        <span class="confirmacion-info-valor">V-8.765.432</span>
                    </div>
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Teléfono:</span>
                        <span class="confirmacion-info-valor">0412-1234567</span>
                    </div>
                `,
                "PayPal": `
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Monto a Pagar:</span>
                        <span class="confirmacion-info-valor text-primary fw-bold">${formattedTotalUSD} USD</span>
                    </div>
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Tasa de Referencia:</span>
                        <span class="confirmacion-info-valor">${tasaHoy} VES/USD</span>
                    </div>

                    <div class="confirmacion-info-divider"></div>

                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Cuenta PayPal:</span>
                        <span class="confirmacion-info-valor">pagos@yosoyarte.com</span>
                    </div>
                    <div class="confirmacion-info-item">
                        <span class="confirmacion-info-label">Instrucciones:</span>
                        <span class="confirmacion-info-valor">Realice el pago directamente en PayPal y adjunte el comprobante.</span>
                    </div>
                `
            };

            // Elementos del DOM
            const $select = $('#MetodoPago');
            const $infoBox = $('#confirmacion-info-caja');
            const $content = $('#confirmacion-info-detalle');

            // Función para actualizar información de pago
            function updatePaymentInfo() {
                const selectedMethod = $select.val();

                if (selectedMethod && PAYMENT_DETAILS[selectedMethod]) {
                    $content.html(PAYMENT_DETAILS[selectedMethod]);
                    $infoBox.slideDown(300);
                } else {
                    $infoBox.slideUp(300);
                }
            }

            // Evento cambio de método de pago
            $select.on('change', updatePaymentInfo);

            // Validación del formulario
            $('form').on('submit', function(e) {
                const fileInput = $('#comprobanteArchivo')[0];
                const maxSize = 5 * 1024 * 1024; // 5MB

                if (fileInput.files.length > 0) {
                    const fileSize = fileInput.files[0].size;
                    if (fileSize > maxSize) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Archivo muy grande',
                            text: 'El comprobante no debe superar los 5MB.',
                            confirmButtonColor: '#ef8830'
                        });
                    }
                }
            });
        });
    </script>
}