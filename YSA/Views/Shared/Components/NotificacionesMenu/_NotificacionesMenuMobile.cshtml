@model YSA.Web.Models.ViewModels.NotificacionMenuWrapperViewModel

@{
    var totalNoLeidas = Model.TotalNoLeidas;
    var mostrarHeader = ViewBag.MostrarHeader ?? true; // Por defecto true
}

<div class="mobile-notificaciones-container p-2">
    <!-- Header -->
    @if (mostrarHeader)
    {
        <!-- Header - solo se muestra si no estamos en modal -->
        <div class="d-flex justify-content-between align-items-center mb-2 px-1">
            <h6 class="mb-0 fw-bold small">Notificaciones</h6>
            @if (totalNoLeidas > 0)
            {
                <span class="badge bg-danger rounded-pill" style="font-size: 0.7rem;">@totalNoLeidas nuevas</span>
            }
        </div>
    }

    @if (Model.Notificaciones != null && Model.Notificaciones.Any())
    {
        <div class="notificaciones-lista-mobile" style="max-height: 300px; overflow-y: auto;">
            @foreach (var notificacion in Model.Notificaciones.Take(3))
            {
                <a class="d-flex align-items-start p-2 mb-2 rounded text-decoration-none"
                   href="@notificacion.UrlDestino"
                   style="background-color: @(notificacion.EsLeida ? "#f8f9fa" : "#fff3e0"); color: inherit; border-left: 3px solid @(notificacion.EsLeida ? "transparent" : "var(--color-brand-primary)");"
                   onclick="marcarComoLeidaMobile(@notificacion.Id, this)">

                    <!-- Icono -->
                    <div class="me-2">
                        <i class="fas fa-@notificacion.Icono text-@notificacion.Color" style="font-size: 1rem;"></i>
                    </div>

                    <!-- Contenido -->
                    <div class="flex-grow-1" style="min-width: 0;">
                        <div class="small fw-bold @(notificacion.EsLeida ? "text-muted" : "")">@notificacion.Titulo</div>
                        <div class="small text-muted text-truncate">@notificacion.Mensaje</div>
                        <small class="text-muted" style="font-size: 0.6rem;">@notificacion.TiempoTranscurrido</small>
                    </div>

                    <!-- Badge nuevo -->
                    @if (!notificacion.EsLeida)
                    {
                        <span class="badge bg-primary rounded-pill ms-1" style="font-size: 0.5rem; height: 8px; width: 8px; padding: 0;"></span>
                    }
                </a>
            }
        </div>

        <!-- Footer con acciones -->
        <div class="d-flex gap-1 mt-2">
            <a href="/Notificaciones" class="btn btn-outline-primary btn-sm flex-grow-1" style="font-size: 0.75rem;">
                <i class="fas fa-list me-1"></i>Ver todas
            </a>
            @if (totalNoLeidas > 0)
            {
                <button class="btn btn-outline-secondary btn-sm flex-grow-1" style="font-size: 0.75rem;" onclick="marcarTodasComoLeidasMobile()">
                    <i class="fas fa-check-double me-1"></i>Marcar todas
                </button>
            }
        </div>
    }
    else
    {
        <!-- Estado vacío -->
        <div class="text-center py-4">
            <i class="fas fa-bell-slash text-muted mb-2" style="font-size: 2rem;"></i>
            <p class="small text-muted mb-0">No tienes notificaciones</p>
        </div>
    }
</div>

<script>
    function marcarComoLeidaMobile(id, element) {
        // Marcar visualmente
        element.style.backgroundColor = '#f8f9fa';
        element.style.borderLeftColor = 'transparent';
        const badge = element.querySelector('.badge');
        if (badge) badge.remove();

        // Llamada AJAX
        fetch('/Notificaciones/MarcarComoLeida', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': getAntiForgeryToken()
            },
            body: JSON.stringify({ id: id })
        });
    }

    function marcarTodasComoLeidasMobile() {
        fetch('/Notificaciones/MarcarTodasComoLeidas', {
            method: 'POST',
            headers: {
                'RequestVerificationToken': getAntiForgeryToken()
            }
        }).then(() => location.reload());
    }

    function getAntiForgeryToken() {
        const token = document.querySelector('input[name="__RequestVerificationToken"]');
        return token ? token.value : '';
    }
</script>