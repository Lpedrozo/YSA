@model YSA.Web.Models.ViewModels.LoginViewModel
@using Microsoft.AspNetCore.Identity
@using YSA.Core.Entities
@inject SignInManager<Usuario> SignInManager

@{
    ViewData["Title"] = "Iniciar Sesión";
    ViewData["ReturnUrl"] = ViewData["ReturnUrl"] ?? Url.Content("~/");
}

<div class="login-compact-style">
    <!-- Fondo decorativo compacto -->
    <div class="login-bg-compact">
        <div class="login-shape-compact shape-1"></div>
        <div class="login-shape-compact shape-2"></div>
        <div class="login-shape-compact shape-3"></div>
    </div>

    <!-- EN LA VISTA DE LOGIN (sustituye el div actual) -->
    <div class="login-split-container login-split-reverse">
        <!-- Video animado a la izquierda -->
        <div class="login-image-side login-image-mobile">
            <div class="login-video-container">
                <video autoplay loop muted playsinline class="login-animated-video">
                    <source src="~/diseño/Banner.mp4" type="video/mp4">
                    <!-- Fallback en caso de que el video no se cargue -->
                    <img src="~/diseño/NIÑALOGIN.png" alt="Niño Yo Soy Arte" class="login-child-image">
                </video>
                <!-- Decoración del video -->
                <div class="video-decoration">
                    <div class="decoration-circle circle-1"></div>
                    <div class="decoration-circle circle-2"></div>
                    <div class="decoration-circle circle-3"></div>
                </div>
            </div>
        </div>

        <!-- Formulario a la derecha -->
        <div class="login-form-side">
            <div class="login-compact-card">

                <!-- Formulario de login -->
                <form asp-controller="Cuenta" asp-action="Login" method="post" class="login-compact-form">
                    <div asp-validation-summary="ModelOnly" class="login-validation-compact"></div>
                    <input type="hidden" asp-for="ReturnUrl" value="@ViewData["ReturnUrl"]" />
                    <div class="login-compact-header">
                        <h2 class="login-compact-title">
                            ¡Inicia sesión!
                        </h2>
                    </div>
                    <div class="form-group-compact">
                        <label class="form-label-compact-above">
                            <i class="fas fa-envelope me-1"></i>
                            Correo Electrónico
                        </label>
                        <div class="input-group-compact">
                            <input asp-for="Email" type="email" class="form-input-compact"
                                   placeholder="Ingresa tu correo electrónico" required>
                            <div class="form-line-compact"></div>
                        </div>
                        <span asp-validation-for="Email" class="form-error-compact"></span>
                    </div>

                    <div class="form-group-compact">
                        <label class="form-label-compact-above">
                            <i class="fas fa-lock me-1"></i>
                            Contraseña
                        </label>
                        <div class="input-group-compact">
                            <input asp-for="Contrasena" type="password"
                                   class="form-input-compact" placeholder="Ingresa tu contraseña" required>
                            <button type="button" class="password-toggle-compact" id="togglePasswordLogin">
                                <i class="fas fa-eye"></i>
                            </button>
                            <div class="form-line-compact"></div>
                        </div>
                        <span asp-validation-for="Contrasena" class="form-error-compact"></span>
                    </div>

                    <div class="form-options-compact">
                        <div class="form-check-compact">
                            <input class="form-check-input-compact" type="checkbox" id="rememberMe">
                            <label class="form-check-label-compact" for="rememberMe">
                                Recordarme
                            </label>
                        </div>
                        <a asp-controller="Cuenta" asp-action="ForgotPassword"
                           class="forgot-password-link-compact">
                            ¿Olvidaste tu contraseña?
                        </a>
                    </div>

                    <button type="submit" class="login-button-compact">
                        <span class="button-text-compact">Iniciar Sesión</span>
                        <i class="fas fa-arrow-right button-icon-compact"></i>
                    </button>
                </form>
                <!-- Separador -->
                @{
                    var loginProviders = (await SignInManager.GetExternalAuthenticationSchemesAsync()).ToList();
                }

                @if (loginProviders.Count > 0)
                {
                    <div class="separator-compact">
                        <span class="separator-text-compact">O continuar con</span>
                    </div>

                    <!-- Login externo -->
                    <form asp-controller="Cuenta" asp-action="ExternalLogin"
                          asp-route-returnurl="@ViewData["ReturnUrl"]" method="post"
                          class="external-login-form-compact">
                        @foreach (var p in loginProviders)
                        {
                            <button type="submit" class="external-login-button-compact google-button-compact"
                                    name="provider" value="@p.Name"
                                    title="Iniciar sesión con tu cuenta de @p.DisplayName">
                                <i class="fab fa-google external-icon-compact"></i>
                                <span>Google</span>
                            </button>
                        }
                    </form>
                }

                <!-- Enlace a registro -->
                <div class="login-footer-compact">
                    <p class="login-footer-text-compact">
                        ¿No tienes una cuenta?
                        <a asp-controller="Cuenta" asp-action="Register"
                           class="register-link-compact">
                            Regístrate aquí
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        const videoContainer = document.querySelector('.login-video-container');
            const video = document.querySelector('.login-animated-video');
            const fallbackImage = document.querySelector('.login-child-image');

            if (video && videoContainer) {
                // Mostrar indicador de carga
                videoContainer.classList.add('loading');

                // Cuando el video se carga
                video.addEventListener('loadeddata', function() {
                    videoContainer.classList.remove('loading');

                    // Intentar reproducir el video
                    const playPromise = video.play();

                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log('Auto-play fue prevenido:', error);
                            // Mostrar imagen de fallback si el video no puede reproducirse
                            if (fallbackImage) {
                                video.style.display = 'none';
                                fallbackImage.style.display = 'block';
                            }
                        });
                    }
                });

                // Si hay error cargando el video
                video.addEventListener('error', function() {
                    videoContainer.classList.remove('loading');
                    console.log('Error cargando el video');

                    // Mostrar imagen de fallback
                    if (fallbackImage) {
                        video.style.display = 'none';
                        fallbackImage.style.display = 'block';
                    }
                });

                // Asegurar que el video esté muteado (para autoplay)
                video.muted = true;

                // Forzar reproducción en bucle
                video.loop = true;

                // Prevenir controles por defecto
                video.controls = false;     
                    if (window.innerWidth <= 768) {
            // En móviles, podemos pausar el video para ahorrar batería
            if (video) {
                video.pause();

                // Reproducir solo cuando el usuario interactúe con el contenedor
                videoContainer.addEventListener('click', function() {
                    if (video.paused) {
                        video.play();
                    }
                });
            }
        }
                const togglePasswordLogin = document.getElementById('togglePasswordLogin');
            const passwordLoginInput = document.getElementById('Contrasena');

            if (togglePasswordLogin && passwordLoginInput) {
                togglePasswordLogin.addEventListener('click', function() {
                    const type = passwordLoginInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordLoginInput.setAttribute('type', type);

                    const icon = this.querySelector('i');
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            }

            // Animación para inputs
            const inputs = document.querySelectorAll('.form-input-compact');
            inputs.forEach(input => {
                // Añadir clase cuando el input tiene valor
                input.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                        this.parentElement.classList.add('has-value');
                    } else {
                        this.parentElement.classList.remove('has-value');
                    }
                });

                // Añadir clase cuando el input está enfocado
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('is-focused');
                });

                input.addEventListener('blur', function() {
                    this.parentElement.classList.remove('is-focused');
                    if (this.value.trim() !== '') {
                        this.parentElement.classList.add('has-value');
                    }
                });

                // Inicializar estado si ya tiene valor
                if (input.value.trim() !== '') {
                    input.parentElement.classList.add('has-value');
                }
            });

            // Validación de errores
            document.querySelectorAll('[data-valmsg-for]').forEach(span => {
                const inputId = span.getAttribute('data-valmsg-for');
                const input = document.getElementById(inputId);

                if (!input) return;

                const observer = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            const parent = input.closest('.input-group-compact');
                            if (span.innerHTML.trim() !== "" && span.innerHTML.trim() !== "[]") {
                                parent.classList.add('has-error');
                            } else {
                                parent.classList.remove('has-error');
                            }
                        }
                    });
                });

                observer.observe(span, { childList: true, characterData: true, subtree: true });
            });
        });
    </script>

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}