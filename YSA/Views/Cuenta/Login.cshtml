@model YSA.Web.Models.ViewModels.LoginViewModel
@using Microsoft.AspNetCore.Identity
@using YSA.Core.Entities
@inject SignInManager<Usuario> SignInManager

@{
    ViewData["Title"] = "Iniciar Sesión";
    ViewData["ReturnUrl"] = ViewData["ReturnUrl"] ?? Url.Content("~/");
}

<div class="auth-github-style">
    <!-- Logo separado arriba del card -->
    <div class="auth-github-logo-container">
        <!-- Logo de YoSoyArte -->
        <img src="~/diseño/horizontal.png"
             alt="Yo Soy Arte"
             class="auth-github-logo-image">
    </div>

    <div class="auth-github-card">
        @{
            var loginProviders = (await SignInManager.GetExternalAuthenticationSchemesAsync()).ToList();
        }

        <!-- FORMULARIO PRINCIPAL -->
        <form asp-controller="Cuenta" asp-action="Login" method="post" class="auth-github-form">
            <div asp-validation-summary="ModelOnly" class="auth-github-validation"></div>
            <input type="hidden" asp-for="ReturnUrl" value="@ViewData["ReturnUrl"]" />

            <div class="auth-github-form-group">
                <label asp-for="Email" class="auth-github-label">Correo Electrónico</label>
                <input asp-for="Email" type="email" class="auth-github-input" placeholder="ejemplo@correo.com" required>
                <span asp-validation-for="Email" class="text-danger small mt-1 d-block"></span>
            </div>

            <div class="auth-github-form-group">
                <label asp-for="Contrasena" class="auth-github-label d-flex justify-content-between">
                    <span>Contraseña</span>
                    <a href="#" class="auth-github-link" style="font-size: 0.8rem;">¿Olvidaste tu contraseña?</a>
                </label>
                <div class="auth-github-password-container">
                    <input asp-for="Contrasena" type="password" class="auth-github-input" placeholder="Tu contraseña" required>
                    <button type="button" class="auth-github-password-toggle" id="togglePasswordLogin">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="Contrasena" class="text-danger small mt-1 d-block"></span>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="auth-github-btn">
                    Iniciar sesión
                </button>
            </div>

            @if (loginProviders.Count == 0)
            {
                <div class="auth-github-links">
                    <a href="#" class="auth-github-link">¿Olvidaste tu contraseña?</a>
                </div>
            }
        </form>

        @if (loginProviders.Count > 0)
        {
            <div class="auth-github-separator">
                O continúa con
            </div>

            <form asp-controller="Cuenta" asp-action="ExternalLogin" asp-route-returnurl="@ViewData["ReturnUrl"]" method="post" class="auth-github-external-form">
                <div class="d-grid gap-2">
                    @foreach (var p in loginProviders)
                    {
                        <button type="submit" class="auth-github-btn-external"
                                name="provider"
                                value="@p.Name"
                                title="Iniciar sesión con tu cuenta de @p.DisplayName">
                            <i class="fab fa-google"></i>
                            Continuar con Google
                        </button>
                    }
                </div>
            </form>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Validación visual de errores en inputs
            document.querySelectorAll('[data-valmsg-for]').forEach(span => {
                const inputId = span.getAttribute('data-valmsg-for');
                const input = document.getElementById(inputId);

                if (!input) return;

                const observer = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            if (span.innerHTML.trim() !== "" && span.innerHTML.trim() !== "[]") {
                                input.classList.add('input-validation-error');
                            } else {
                                input.classList.remove('input-validation-error');
                            }
                        }
                    });
                });

                observer.observe(span, { childList: true, characterData: true, subtree: true });

                // Verificación inicial
                if (span.innerHTML.trim() !== "" && span.innerHTML.trim() !== "[]") {
                    input.classList.add('input-validation-error');
                }
            });

            // Alternar visibilidad de contraseña
            const togglePasswordLogin = document.getElementById('togglePasswordLogin');
            const passwordLoginInput = document.getElementById('Contrasena');

            if (togglePasswordLogin && passwordLoginInput) {
                togglePasswordLogin.addEventListener('click', function() {
                    const type = passwordLoginInput.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordLoginInput.setAttribute('type', type);

                    const icon = this.querySelector('i');
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                });
            }
        });
    </script>

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}