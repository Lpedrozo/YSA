@model YSA.Web.Models.ViewModels.RegistroViewModel
@using Microsoft.AspNetCore.Identity
@using YSA.Core.Entities
@inject SignInManager<Usuario> SignInManager

@{
    ViewData["Title"] = "Crear una cuenta";
    ViewData["ReturnUrl"] = ViewData["ReturnUrl"] ?? Url.Content("~/");
}

<div class="auth-github-style">
    <!-- Logo separado arriba del card -->
    <div class="auth-github-logo-container">
        <!-- Logo de YoSoyArte -->
        <img src="~/diseño/horizontal.png"
             alt="Yo Soy Arte"
             class="auth-github-logo-image">
    </div>

    <div class="auth-register-card">
        @{
            var loginProviders = (await SignInManager.GetExternalAuthenticationSchemesAsync()).ToList();
        }

        @if (loginProviders.Count > 0)
        {
            <form asp-controller="Cuenta" asp-action="ExternalLogin" asp-route-returnurl="@ViewData["ReturnUrl"]" method="post" class="auth-github-external-form">
                @if (TempData["Error"] != null)
                {
                    <div class="auth-github-validation mb-3">
                        @TempData["Error"]
                    </div>
                }

                <div class="d-grid gap-2 mb-3">
                    @foreach (var p in loginProviders)
                    {
                        <button type="submit" class="auth-github-btn-external"
                                name="provider"
                                value="@p.Name"
                                title="Registrarse usando tu cuenta de @p.DisplayName">
                            <i class="fab fa-google"></i>
                            Continuar con Google
                        </button>
                    }
                </div>

            </form>
        }

        <!-- FORMULARIO PRINCIPAL DE REGISTRO -->
        <form asp-controller="Cuenta" asp-action="Registro" method="post" class="auth-github-form">
            <div asp-validation-summary="ModelOnly" class="auth-github-validation"></div>

            <div class="auth-register-form-group-row">
                <div class="auth-github-form-group">
                    <label asp-for="Nombre" class="auth-github-label">Nombre</label>
                    <input asp-for="Nombre" type="text" class="auth-github-input" placeholder="Tu nombre" required>
                    <span asp-validation-for="Nombre" class="text-danger small mt-1 d-block"></span>
                </div>

                <div class="auth-github-form-group">
                    <label asp-for="Apellido" class="auth-github-label">Apellido</label>
                    <input asp-for="Apellido" type="text" class="auth-github-input" placeholder="Tu apellido" required>
                    <span asp-validation-for="Apellido" class="text-danger small mt-1 d-block"></span>
                </div>
            </div>

            <div class="auth-github-form-group">
                <label asp-for="Email" class="auth-github-label">Correo Electrónico</label>
                <input asp-for="Email" type="email" class="auth-github-input" placeholder="ejemplo@correo.com" required>
                <span asp-validation-for="Email" class="text-danger small mt-1 d-block"></span>
            </div>

            <div class="auth-github-form-group">
                <label asp-for="Contrasena" class="auth-github-label">Contraseña</label>
                <div class="auth-github-password-container">
                    <input asp-for="Contrasena" type="password" class="auth-github-input" placeholder="Crea una contraseña segura" required>
                    <button type="button" class="auth-github-password-toggle" id="togglePasswordRegister">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="Contrasena" class="text-danger small mt-1 d-block"></span>
            </div>

            <div class="auth-github-form-group">
                <label asp-for="ConfirmarContrasena" class="auth-github-label">Confirmar Contraseña</label>
                <div class="auth-github-password-container">
                    <input asp-for="ConfirmarContrasena" type="password" class="auth-github-input" placeholder="Repite la contraseña" required>
                    <button type="button" class="auth-github-password-toggle" id="toggleConfirmPasswordRegister">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <span asp-validation-for="ConfirmarContrasena" class="text-danger small mt-1 d-block"></span>
            </div>

            <div class="auth-terms-check">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="acceptTerms" required>
                    <label class="form-check-label" for="acceptTerms">
                        Acepto los <a href="#" target="_blank">Términos de Servicio</a> y la <a href="#" target="_blank">Política de Privacidad</a> de Yo Soy Arte
                    </label>
                </div>
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="auth-github-btn">
                    Crear cuenta
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Validación visual de errores en inputs
            document.querySelectorAll('[data-valmsg-for]').forEach(span => {
                const inputId = span.getAttribute('data-valmsg-for');
                const input = document.getElementById(inputId);

                if (!input) return;

                const observer = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            if (span.innerHTML.trim() !== "" && span.innerHTML.trim() !== "[]") {
                                input.classList.add('input-validation-error');
                            } else {
                                input.classList.remove('input-validation-error');
                            }
                        }
                    });
                });

                observer.observe(span, { childList: true, characterData: true, subtree: true });

                // Verificación inicial
                if (span.innerHTML.trim() !== "" && span.innerHTML.trim() !== "[]") {
                    input.classList.add('input-validation-error');
                }
            });

            // Configurar toggle de visibilidad de contraseñas
            function setupPasswordToggle(toggleId, inputId) {
                const toggleIcon = document.getElementById(toggleId);
                const passwordInput = document.getElementById(inputId);

                if (toggleIcon && passwordInput) {
                    toggleIcon.addEventListener('click', function() {
                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                        passwordInput.setAttribute('type', type);

                        const icon = this.querySelector('i');
                        icon.classList.toggle('fa-eye');
                        icon.classList.toggle('fa-eye-slash');
                    });
                }
            }

            // Inicializar la funcionalidad para ambos campos de contraseña
            setupPasswordToggle('togglePasswordRegister', 'Contrasena');
            setupPasswordToggle('toggleConfirmPasswordRegister', 'ConfirmarContrasena');

            // Validación del checkbox de términos
            const form = document.querySelector('form[asp-controller="Cuenta"][asp-action="Registro"]');
            const termsCheckbox = document.getElementById('acceptTerms');

            if (form && termsCheckbox) {
                form.addEventListener('submit', function(e) {
                    if (!termsCheckbox.checked) {
                        e.preventDefault();
                        alert('Debes aceptar los Términos de Servicio y la Política de Privacidad para continuar.');
                        termsCheckbox.focus();
                    }
                });
            }
        });
    </script>

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}