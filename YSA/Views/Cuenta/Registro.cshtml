@model YSA.Web.Models.ViewModels.RegistroViewModel
@using Microsoft.AspNetCore.Identity
@using YSA.Core.Entities
@inject SignInManager<Usuario> SignInManager

@{
    ViewData["Title"] = "Crear una cuenta";
    ViewData["ReturnUrl"] = ViewData["ReturnUrl"] ?? Url.Content("~/");
}

<div class="login-compact-style">
    <!-- Fondo decorativo compacto -->
    <div class="login-bg-compact">
        <div class="login-shape-compact shape-1"></div>
        <div class="login-shape-compact shape-2"></div>
        <div class="login-shape-compact shape-3"></div>
    </div>

    <!-- Contenedor principal con formulario a la izquierda e imagen a la derecha -->
    <div class="login-split-container mt-5 pt-5">
        <!-- Formulario a la izquierda -->
        <div class="login-form-side">
            <div class="login-compact-card">
                <!-- Logo y título -->
                <div class="login-compact-header">
                    <h2 class="login-compact-title">
                        <i class="fas fa-user-plus me-1"></i>
                        ¡Crea tu cuenta!
                    </h2>
                </div>

                <!-- Formulario de registro -->
                <form asp-controller="Cuenta" asp-action="Registro" method="post" class="login-compact-form">
                    <div asp-validation-summary="ModelOnly" class="login-validation-compact"></div>
                    <input type="hidden" asp-for="ReturnUrl" value="@ViewData["ReturnUrl"]" />

                    <!-- Campos en fila para nombre y apellido -->
                    <div class="form-row-compact">
                        <div class="form-group-compact">
                            <div class="input-group-compact">
                                <input asp-for="Nombre" type="text" class="form-input-compact"
                                       placeholder=" " required>
                                <label class="form-label-compact">
                                    <i class="fas fa-user me-1"></i>
                                    Nombre
                                </label>
                                <div class="form-line-compact"></div>
                            </div>
                            <span asp-validation-for="Nombre" class="form-error-compact"></span>
                        </div>

                        <div class="form-group-compact">
                            <div class="input-group-compact">
                                <input asp-for="Apellido" type="text" class="form-input-compact"
                                       placeholder=" " required>
                                <label class="form-label-compact">
                                    <i class="fas fa-user me-1"></i>
                                    Apellido
                                </label>
                                <div class="form-line-compact"></div>
                            </div>
                            <span asp-validation-for="Apellido" class="form-error-compact"></span>
                        </div>
                    </div>

                    <div class="form-group-compact">
                        <div class="input-group-compact">
                            <input asp-for="Email" type="email" class="form-input-compact"
                                   placeholder=" " required>
                            <label class="form-label-compact">
                                <i class="fas fa-envelope me-1"></i>
                                Correo Electrónico
                            </label>
                            <div class="form-line-compact"></div>
                        </div>
                        <span asp-validation-for="Email" class="form-error-compact"></span>
                    </div>

                    <div class="form-group-compact">
                        <div class="input-group-compact">
                            <input asp-for="Contrasena" type="password"
                                   class="form-input-compact" placeholder=" " required>
                            <label class="form-label-compact">
                                <i class="fas fa-lock me-1"></i>
                                Contraseña
                            </label>
                            <button type="button" class="password-toggle-compact" id="togglePasswordRegister">
                                <i class="fas fa-eye"></i>
                            </button>
                            <div class="form-line-compact"></div>
                        </div>
                        <span asp-validation-for="Contrasena" class="form-error-compact"></span>
                    </div>

                    <div class="form-group-compact">
                        <div class="input-group-compact">
                            <input asp-for="ConfirmarContrasena" type="password"
                                   class="form-input-compact" placeholder=" " required>
                            <label class="form-label-compact">
                                <i class="fas fa-lock me-1"></i>
                                Confirmar Contraseña
                            </label>
                            <button type="button" class="password-toggle-compact" id="toggleConfirmPasswordRegister">
                                <i class="fas fa-eye"></i>
                            </button>
                            <div class="form-line-compact"></div>
                        </div>
                        <span asp-validation-for="ConfirmarContrasena" class="form-error-compact"></span>
                    </div>

                    <!-- Checkbox de términos con estilo compacto -->
                    <div class="form-options-compact terms-check-compact">
                        <div class="form-check-compact">
                            <input class="form-check-input-compact" type="checkbox" id="acceptTerms" required>
                            <label class="form-check-label-compact" for="acceptTerms">
                                Acepto los <a asp-controller="Home" asp-action="Terms" target="_blank" class="terms-link-compact">Términos de Servicio</a> y la <a asp-controller="Home" asp-action="Privacy" target="_blank" class="terms-link-compact">Política de Privacidad</a>
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="login-button-compact">
                        <span class="button-text-compact">Crear Cuenta</span>
                        <i class="fas fa-user-plus button-icon-compact"></i>
                    </button>
                </form>

                <!-- Separador -->
                @{
                    var loginProviders = (await SignInManager.GetExternalAuthenticationSchemesAsync()).ToList();
                }

                @if (loginProviders.Count > 0)
                {
                    <div class="separator-compact">
                        <span class="separator-text-compact">O registrarse con</span>
                    </div>

                    <!-- Login externo -->
                    <form asp-controller="Cuenta" asp-action="ExternalLogin"
                          asp-route-returnurl="@ViewData["ReturnUrl"]" method="post"
                          class="external-login-form-compact">
                        @foreach (var p in loginProviders)
                        {
                            <button type="submit" class="external-login-button-compact google-button-compact"
                                    name="provider" value="@p.Name"
                                    title="Registrarse con tu cuenta de @p.DisplayName">
                                <i class="fab fa-google external-icon-compact"></i>
                                <span>Google</span>
                            </button>
                        }
                    </form>
                }

                <!-- Enlace a login -->
                <div class="login-footer-compact">
                    <p class="login-footer-text-compact">
                        ¿Ya tienes una cuenta?
                        <a asp-controller="Cuenta" asp-action="Login"
                           class="register-link-compact">
                            Inicia sesión aquí
                        </a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Video animado a la derecha -->
        <div class="login-image-side login-image-mobile">
            <div class="login-video-container">
                <video autoplay loop muted playsinline class="login-animated-video">
                    <source src="~/diseño/LOGOS YSA.mp4" type="video/mp4">
                    <!-- Fallback en caso de que el video no se cargue -->
                    <img src="~/diseño/NiñaRegister.png" alt="Niña Yo Soy Arte" class="login-child-image">
                </video>
                <!-- Indicador de video -->
                <div class="video-indicator">
                    <i class="fas fa-play-circle me-1"></i>
                    Video
                </div>
                <!-- Decoración del video -->
                <div class="video-decoration">
                    <div class="decoration-circle circle-1"></div>
                    <div class="decoration-circle circle-2"></div>
                    <div class="decoration-circle circle-3"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Alternar visibilidad de contraseñas
            const setupPasswordToggle = (toggleId, inputId) => {
                const toggleButton = document.getElementById(toggleId);
                const input = document.getElementById(inputId);

                if (toggleButton && input) {
                    toggleButton.addEventListener('click', function() {
                        const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                        input.setAttribute('type', type);

                        const icon = this.querySelector('i');
                        icon.classList.toggle('fa-eye');
                        icon.classList.toggle('fa-eye-slash');
                    });
                }
            };

            // Configurar ambos campos de contraseña
            setupPasswordToggle('togglePasswordRegister', 'Contrasena');
            setupPasswordToggle('toggleConfirmPasswordRegister', 'ConfirmarContrasena');

            // Animación para inputs
            const inputs = document.querySelectorAll('.form-input-compact');
            inputs.forEach(input => {
                // Añadir clase cuando el input tiene valor
                input.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                        this.parentElement.classList.add('has-value');
                    } else {
                        this.parentElement.classList.remove('has-value');
                    }
                });

                // Añadir clase cuando el input está enfocado
                input.addEventListener('focus', function() {
                    this.parentElement.classList.add('is-focused');
                });

                input.addEventListener('blur', function() {
                    this.parentElement.classList.remove('is-focused');
                    if (this.value.trim() !== '') {
                        this.parentElement.classList.add('has-value');
                    }
                });

                // Inicializar estado si ya tiene valor
                if (input.value.trim() !== '') {
                    input.parentElement.classList.add('has-value');
                }
            });

            // Validación de errores
            document.querySelectorAll('[data-valmsg-for]').forEach(span => {
                const inputId = span.getAttribute('data-valmsg-for');
                const input = document.getElementById(inputId);

                if (!input) return;

                const observer = new MutationObserver(mutations => {
                    mutations.forEach(mutation => {
                        if (mutation.type === 'childList' || mutation.type === 'characterData') {
                            const parent = input.closest('.input-group-compact');
                            if (span.innerHTML.trim() !== "" && span.innerHTML.trim() !== "[]") {
                                parent.classList.add('has-error');
                            } else {
                                parent.classList.remove('has-error');
                            }
                        }
                    });
                });

                observer.observe(span, { childList: true, characterData: true, subtree: true });
            });

            // Validación del checkbox de términos
            const form = document.querySelector('form[asp-controller="Cuenta"][asp-action="Registro"]');
            const termsCheckbox = document.getElementById('acceptTerms');

            if (form && termsCheckbox) {
                form.addEventListener('submit', function(e) {
                    if (!termsCheckbox.checked) {
                        e.preventDefault();
                        // Mostrar mensaje de error
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'terms-error-compact';
                        errorMessage.innerHTML = '<i class="fas fa-exclamation-circle me-1"></i>Debes aceptar los Términos de Servicio y la Política de Privacidad para continuar.';

                        // Remover mensajes de error previos
                        const existingError = document.querySelector('.terms-error-compact');
                        if (existingError) {
                            existingError.remove();
                        }

                        // Añadir mensaje de error
                        termsCheckbox.closest('.terms-check-compact').appendChild(errorMessage);

                        // Resaltar el checkbox
                        termsCheckbox.classList.add('has-error');

                        // Scroll al error
                        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                });

                // Remover mensaje de error cuando se marque el checkbox
                termsCheckbox.addEventListener('change', function() {
                    const errorMessage = document.querySelector('.terms-error-compact');
                    if (errorMessage && this.checked) {
                        errorMessage.remove();
                        this.classList.remove('has-error');
                    }
                });
            }

            // Control de video - Reiniciar si hay problemas
            const video = document.querySelector('.login-animated-video');
            if (video) {
                // Intentar cargar el video si falla
                video.addEventListener('error', function() {
                    console.log('Error al cargar el video, mostrando imagen de respaldo');
                });

                // Asegurarse de que el video esté en silencio para autoplay
                video.muted = true;

                // Intentar reproducir programáticamente (para algunos navegadores)
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        console.log('Autoplay falló, intentando con interacción del usuario');
                        // Podríamos añadir un botón de play aquí si es necesario
                    });
                }
            }
        });
    </script>

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}