@model List<YSA.Core.Entities.Notificacion>
@{
    ViewData["Title"] = "Mis Notificaciones";
}

<div class="container px-0 py-5 pb-5 mb-5">
    <!-- SECCIÓN PRINCIPAL DE NOTIFICACIONES -->
    <div class="section-container">
        <!-- ENCABEZADO Y CONTROLES -->
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4">
            <div class="mb-3 mb-md-0">
                <span class="section-title">CENTRO DE NOTIFICACIONES</span>
                <p class="text-muted mt-2 mb-0">Gestiona y revisa todas tus notificaciones en un solo lugar</p>
            </div>

            <div class="d-flex flex-wrap gap-2">
                <button id="markAllRead" class="btn btn-outline-primary">
                    <i class="fas fa-check-double me-2"></i> Marcar todas como leídas
                </button>
                <a asp-action="Index" asp-controller="Home" class="btn btn-primary">
                    <i class="fas fa-home me-2"></i> Ir al inicio
                </a>
            </div>
        </div>

        <!-- ESTADÍSTICAS RÁPIDAS -->
        @{
            var totalNotificaciones = Model?.Count ?? 0;
            var noLeidas = Model?.Count(n => !n.EsLeida) ?? 0;
            var leidas = totalNotificaciones - noLeidas;
        }

        <div class="row g-4 mb-4">
            <div class="col-md-4">
                <div class="info-box text-center">
                    <h5 class="text-brand-primary mb-2">
                        <i class="fas fa-bell me-2"></i>Total
                    </h5>
                    <h3 class="mb-0">@totalNotificaciones</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-box text-center">
                    <h5 class="text-brand-secondary mb-2">
                        <i class="fas fa-envelope me-2"></i>No Leídas
                    </h5>
                    <h3 class="mb-0">@noLeidas</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-box text-center">
                    <h5 class="text-brand-success mb-2">
                        <i class="fas fa-envelope-open me-2"></i>Leídas
                    </h5>
                    <h3 class="mb-0">@leidas</h3>
                </div>
            </div>
        </div>

        <!-- FILTROS -->
        <div class="filtro-menu mb-4">
            <div class="filtro-item">
                <a href="?filtro=todas" class="@(ViewBag.Filtro == "todas" || ViewBag.Filtro == null ? "active" : "")">
                    <i class="fas fa-list me-1"></i> Todas
                </a>
            </div>
            <div class="filtro-item">
                <a href="?filtro=noleidas" class="@(ViewBag.Filtro == "noleidas" ? "active" : "")">
                    <i class="fas fa-envelope me-1"></i> No leídas
                </a>
            </div>
            <div class="filtro-item">
                <a href="?filtro=leidas" class="@(ViewBag.Filtro == "leidas" ? "active" : "")">
                    <i class="fas fa-envelope-open me-1"></i> Leídas
                </a>
            </div>
        </div>

        <!-- LISTA DE NOTIFICACIONES -->
        @if (Model != null && Model.Any())
        {
            <div class="notifications-list">
                @foreach (var notificacion in Model.OrderByDescending(n => n.FechaCreacion))
                {
                    <div class="magazine-card mb-3 @(!notificacion.EsLeida ? "notification-unread" : "")" data-notificacion-id="@notificacion.Id">
                        <div class="magazine-card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-3 @GetIconClass(notificacion.TipoNotificacionId)" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
                                        <i class="@GetIcon(notificacion.TipoNotificacionId)"></i>
                                    </div>
                                    <div>
                                        <h5 class="mb-1">@notificacion.Titulo</h5>
                                        <small class="text-muted">@notificacion.TipoNotificacion?.Nombre</small>
                                    </div>
                                </div>
                                @if (!notificacion.EsLeida)
                                {
                                    <span class="badge bg-primary">Nuevo</span>
                                }
                            </div>

                            <p class="card-text mb-3">@notificacion.Mensaje</p>

                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i> @notificacion.FechaCreacion.ToString("dd/MM/yyyy 'a las' hh:mm tt")
                                </small>

                                <div class="d-flex gap-2">
                                    @if (!string.IsNullOrEmpty(notificacion.UrlDestino))
                                    {
                                        <a href="@notificacion.UrlDestino" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-external-link-alt me-1"></i> Ver
                                        </a>
                                    }
                                    @if (!notificacion.EsLeida)
                                    {
                                        <button class="btn btn-sm btn-primary mark-read-btn" data-id="@notificacion.Id">
                                            <i class="fas fa-check me-1"></i> Marcar leída
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-bell-slash fa-4x text-muted opacity-25"></i>
                </div>
                <h4 class="mb-3">No hay notificaciones</h4>
                <p class="text-muted mb-4">No tienes notificaciones en este momento. Te mantendremos informado cuando tengas nuevas actualizaciones.</p>
                <a asp-action="Index" asp-controller="Home" class="btn btn-primary">
                    <i class="fas fa-home me-2"></i> Volver al inicio
                </a>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Marcar notificación como leída
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const notificacionId = this.getAttribute('data-id');
                    const notificacionCard = this.closest('.magazine-card');
                    const button = this;

                    fetch('/Notificaciones/MarcarComoLeida', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ id: parseInt(notificacionId) })
                    }).then(response => {
                        if (response.ok) {
                            // Actualizar interfaz
                            notificacionCard.classList.remove('notification-unread');
                            const badge = notificacionCard.querySelector('.badge');
                            if (badge) badge.remove();
                            button.remove();

                            // Mostrar notificación de éxito
                            Swal.fire({
                                icon: 'success',
                                title: '¡Hecho!',
                                text: 'Notificación marcada como leída',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true
                            });

                            // Actualizar estadísticas después de un breve delay
                            setTimeout(() => {
                                actualizarEstadisticas();
                            }, 500);
                        }
                    }).catch(error => {
                        console.error('Error:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'No se pudo marcar la notificación como leída'
                        });
                    });
                });
            });

            // Marcar todas como leídas
            document.getElementById('markAllRead').addEventListener('click', function() {
                Swal.fire({
                    title: '¿Marcar todas como leídas?',
                    text: "Esta acción marcará todas tus notificaciones no leídas como leídas.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#ef8830',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Sí, marcar todas',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch('/Notificaciones/MarcarTodasComoLeidas', {
                            method: 'POST'
                        }).then(response => {
                            if (response.ok) {
                                // Actualizar interfaz
                                document.querySelectorAll('.magazine-card.notification-unread').forEach(card => {
                                    card.classList.remove('notification-unread');
                                    const badge = card.querySelector('.badge');
                                    if (badge) badge.remove();
                                    const markReadBtn = card.querySelector('.mark-read-btn');
                                    if (markReadBtn) markReadBtn.remove();
                                });

                                // Mostrar notificación de éxito
                                Swal.fire({
                                    icon: 'success',
                                    title: '¡Perfecto!',
                                    text: 'Todas las notificaciones han sido marcadas como leídas',
                                    toast: true,
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 2000,
                                    timerProgressBar: true
                                });

                                // Actualizar estadísticas después de un breve delay
                                setTimeout(() => {
                                    actualizarEstadisticas();
                                }, 500);
                            }
                        }).catch(error => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'No se pudieron marcar todas las notificaciones como leídas'
                            });
                        });
                    }
                });
            });

            function actualizarEstadisticas() {
                // Hacer una llamada para obtener las estadísticas actualizadas
                fetch('/Notificaciones/GetEstadisticas')
                    .then(response => response.json())
                    .then(data => {
                        // Actualizar los contadores en la vista
                        document.querySelectorAll('.info-box h3')[0].textContent = data.total;
                        document.querySelectorAll('.info-box h3')[1].textContent = data.noLeidas;
                        document.querySelectorAll('.info-box h3')[2].textContent = data.leidas;
                    })
                    .catch(error => {
                        console.error('Error al actualizar estadísticas:', error);
                        // Si falla, recargar la página
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    });
            }

            // Animación al pasar el mouse sobre las tarjetas
            const notificacionCards = document.querySelectorAll('.magazine-card');
            notificacionCards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.style.transition = 'all 0.3s ease';
                });
            });
        });
    </script>
}

@functions {
    private string GetIcon(int tipoNotificacionId)
    {
        return tipoNotificacionId switch
        {
            1 => "fas fa-check-circle", // Pago Confirmado
            2 => "fas fa-clock", // Pago Pendiente
            3 => "fas fa-book-open", // Curso Comprado
            4 => "fas fa-file-pdf", // Producto Comprado
            5 => "fas fa-award", // Actividad Calificada
            6 => "fas fa-bullhorn", // Nuevo Anuncio
            7 => "fas fa-comments", // Pregunta Respondida
            8 => "fas fa-chart-line", // Progreso Curso
            9 => "fas fa-shopping-cart", // Nuevo Pedido
            _ => "fas fa-bell"
        };
    }

    private string GetIconClass(int tipoNotificacionId)
    {
        return tipoNotificacionId switch
        {
            1 => "text-success bg-success bg-opacity-10", // Pago Confirmado
            2 => "text-warning bg-warning bg-opacity-10", // Pago Pendiente
            3 => "text-primary bg-primary bg-opacity-10", // Curso Comprado
            4 => "text-info bg-info bg-opacity-10", // Producto Comprado
            5 => "text-success bg-success bg-opacity-10", // Actividad Calificada
            6 => "text-warning bg-warning bg-opacity-10", // Nuevo Anuncio
            7 => "text-primary bg-primary bg-opacity-10", // Pregunta Respondida
            8 => "text-info bg-info bg-opacity-10", // Progreso Curso
            9 => "text-primary bg-primary bg-opacity-10", // Nuevo Pedido
            _ => "text-secondary bg-secondary bg-opacity-10"
        };
    }
}