@model YSA.Web.Models.ViewModels.PagoViewModel
@using System.Globalization;
@{
    ViewData["Title"] = "Procesar pago";

    // Calcular total en Bolívares (VES)
    decimal totalVes = Model.TasaBCV > 0 ? Model.Total * Model.TasaBCV : 0;
    var culture = CultureInfo.InvariantCulture;

    // Datos para WhatsApp
    var whatsappNumber = "584121463374";
    var whatsappMessage = $"Hola, necesito asistencia con el pago del Pedido #{Model.PedidoId}. ¿Me pueden ayudar?";
    var encodedMessage = System.Web.HttpUtility.UrlEncode(whatsappMessage);
    var whatsappLink = $"https://wa.me/{whatsappNumber}?text={encodedMessage}";
}

<div class="container px-0 mt-5 py-5">
    <!-- Tarjeta principal de pago -->
    <div class="pago-tarjeta">
        <!-- Encabezado -->
        <div class="pago-header">
            <span class="pago-id">PEDIDO #@Model.PedidoId</span>
            <h1 class="pago-titulo">Complete los datos de su pago</h1>
        </div>

        <!-- Cuerpo -->
        <div class="pago-body">
            <!-- Monto destacado -->
            <div class="pago-monto">
                <div class="pago-monto-usd">@Model.Total.ToString("N2", culture) USD</div>
                <div class="pago-monto-ves">
                    Equivalente: <strong class="text-success">@totalVes.ToString("N2", culture) VES</strong>
                </div>
                <div class="pago-tasa">
                    <i class="fas fa-exchange-alt me-1"></i>
                    Tasa BCV: @Model.TasaBCV.ToString("N2", culture) VES/USD
                </div>
            </div>

            <!-- Nota informativa -->
            <div class="pago-nota">
                <div class="pago-nota-icono">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <p class="mb-0">Su pedido será validado por un administrador. Una vez confirmado, ¡tendrá acceso!</p>
            </div>

            <!-- Botón de WhatsApp -->
            <div class="d-grid mb-4">
                <a href="@whatsappLink" target="_blank" class="btn pago-whatsapp-btn">
                    <i class="fab fa-whatsapp"></i>
                    Consultar por WhatsApp
                </a>
            </div>

            <!-- Formulario de pago -->
            <form asp-action="ProcesarPago" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <input type="hidden" asp-for="PedidoId" />
                <input type="hidden" asp-for="TasaBCV" />

                <!-- Método de pago -->
                <div class="mb-4">
                    <label asp-for="MetodoPago" class="pago-form-label">
                        <i class="fas fa-credit-card me-1"></i> Método de pago
                    </label>
                    <select asp-for="MetodoPago" class="form-select pago-form-control pago-form-select" id="MetodoPagoSelect" required>
                        <option value="" disabled selected>-- Seleccione un método --</option>
                        <option value="Transferencia Bancaria">Transferencia Bancaria</option>
                        <option value="Pago Móvil">Pago Móvil</option>
                        <option value="PayPal">PayPal</option>
                    </select>
                    <span asp-validation-for="MetodoPago" class="text-danger small"></span>
                </div>

                <!-- Información de pago dinámica -->
                <div class="pago-info-contenedor">
                    <div id="pago-info-caja" class="pago-info-caja" style="display:none;">
                        <h4 class="pago-info-titulo">
                            <i class="fas fa-info-circle"></i> Datos de Pago
                        </h4>
                        <div id="pago-info-detalle" class="pago-info-detalle">
                            <!-- La información se cargará dinámicamente aquí -->
                        </div>
                    </div>
                </div>

                <!-- Referencia de pago -->
                <div class="mb-4">
                    <label asp-for="ReferenciaPago" class="pago-form-label">
                        <i class="fas fa-hashtag me-1"></i> Referencia de pago
                    </label>
                    <input asp-for="ReferenciaPago" class="form-control pago-form-control"
                           placeholder="Ingrese el número de referencia/transacción"
                           required />
                    <div class="form-text">Número de transferencia, comprobante o transacción</div>
                    <span asp-validation-for="ReferenciaPago" class="text-danger small"></span>
                </div>

                <!-- Comprobante -->
                <div class="mb-5">
                    <label asp-for="ComprobanteArchivo" class="pago-form-label">
                        <i class="fas fa-file-upload me-1"></i> Adjuntar comprobante
                    </label>
                    <input asp-for="ComprobanteArchivo" type="file" class="form-control pago-form-control"
                           accept=".jpg,.jpeg,.png,.pdf,.gif"
                           required />
                    <div class="form-text">Formatos aceptados: JPG, PNG, PDF, GIF (Máx. 5MB)</div>
                    <span asp-validation-for="ComprobanteArchivo" class="text-danger small"></span>
                </div>

                <!-- Botón de envío -->
                <div class="d-grid">
                    <button type="submit" class="btn pago-enviar-btn">
                        <i class="fas fa-paper-plane me-1"></i>
                        Registrar pago
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            // Variables globales
            const formattedTotalUSD = '@Html.Raw(Model.Total.ToString("N2", culture))';
            const formattedTotalVES = '@Html.Raw(totalVes.ToString("N2", culture))';
            const tasaHoy = '@Model.TasaBCV.ToString("N2", culture)';

            // Información de pago por método
            const PAYMENT_DETAILS = {
                "Transferencia Bancaria": `
                    <p><strong>Monto a Pagar:</strong> ${formattedTotalVES} VES</p>
                    <p><strong>Tasa utilizada:</strong> ${tasaHoy} VES/USD</p>
                    <p><strong>Banco:</strong> Banco Universal Negro</p>
                    <p><strong>RUC/C.I.:</strong> V-12.345.678</p>
                    <p><strong>Cuenta:</strong> 0102-0304-0506-0708-0910</p>
                    <p><strong>Tipo de cuenta:</strong> Corriente</p>
                    <p><strong>Correo para confirmación:</strong> pagos@yosoyarte.com</p>
                    <p class="pago-info-importante">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        Asegúrese de transferir el monto exacto antes de continuar.
                    </p>
                `,
                "Pago Móvil": `
                    <p><strong>Monto a Pagar:</strong> ${formattedTotalVES} VES</p>
                    <p><strong>Tasa utilizada:</strong> ${tasaHoy} VES/USD</p>
                    <p><strong>Banco:</strong> Banco Móvil</p>
                    <p><strong>Cédula:</strong> V-8.765.432</p>
                    <p><strong>Teléfono:</strong> 0412-1234567</p>
                    <p><strong>Alias/Concepto:</strong> PAGOYOSOYARTE</p>
                    <p class="pago-info-importante">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        El monto total es <strong>${formattedTotalVES} VES</strong>.
                        Use el campo "Referencia" para el Hash/N° de la transacción.
                    </p>
                `,
                "PayPal": `
                    <p><strong>Monto a Pagar:</strong> ${formattedTotalUSD} USD</p>
                    <p><strong>Tasa de referencia:</strong> ${tasaHoy} VES/USD</p>
                    <p><strong>Cuenta PayPal:</strong> pagos@yosoyarte.com</p>
                    <p><strong>Instrucciones:</strong></p>
                    <ol class="mb-3">
                        <li>Acceda a su cuenta de PayPal</li>
                        <li>Enviar dinero a: <strong>pagos@yosoyarte.com</strong></li>
                        <li>Monto: <strong>${formattedTotalUSD} USD</strong></li>
                        <li>Seleccione "Enviar a un amigo" si está disponible</li>
                    </ol>
                    <p class="pago-info-importante">
                        <i class="fas fa-exclamation-circle me-1"></i>
                        Use el campo "Referencia" para su N° de transacción o Hash de PayPal.
                    </p>
                `
            };

            // Elementos del DOM
            const $select = $('#MetodoPagoSelect');
            const $infoBox = $('#pago-info-caja');
            const $content = $('#pago-info-detalle');

            // Función para actualizar información de pago
            function updatePaymentInfo() {
                const selectedMethod = $select.val();

                if (selectedMethod && PAYMENT_DETAILS[selectedMethod]) {
                    $content.html(PAYMENT_DETAILS[selectedMethod]);
                    $infoBox.slideDown(300);
                } else {
                    $infoBox.slideUp(300);
                }
            }

            // Evento cambio de método de pago
            $select.on('change', updatePaymentInfo);

            // Validación del formulario
            $('form').on('submit', function(e) {
                const fileInput = $('#ComprobanteArchivo')[0];
                const maxSize = 5 * 1024 * 1024; // 5MB

                if (fileInput.files.length > 0) {
                    const fileSize = fileInput.files[0].size;
                    if (fileSize > maxSize) {
                        e.preventDefault();
                        Swal.fire({
                            icon: 'error',
                            title: 'Archivo muy grande',
                            text: 'El comprobante no debe superar los 5MB.',
                            confirmButtonColor: '#ef8830'
                        });
                    }
                }
            });

            // Cargar información inicial si ya hay un valor seleccionado
            updatePaymentInfo();
        });
    </script>
}